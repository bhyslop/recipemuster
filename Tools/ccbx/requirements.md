# Claude Code Box Docker Requirements

## Overview
Containerized environment for running Claude Code on Windows via SSH, avoiding Cygwin/Docker terminal compatibility issues.

## Directory Structure
```
Tools/ccbx/
├── requirements.md         # This document
├── build-context/          # Build context directory
│   ├── Dockerfile
│   └── entrypoint.sh       # SSH setup and Claude Code initialization
├── docker-compose.yml
├── .claude-config/         # Persisted Claude config (volume mounted)
└── README.md               # Usage instructions
```

## Dockerfile Requirements

### Base Image
- Ubuntu 24.04 LTS (for stability and long-term support)

### Required Installs

The following utilities are installed in the container based on the specific requirements discussed:

#### Core Dependencies
- **nodejs** - Required runtime for Claude Code (version 18+ needed)
- **npm** - Package manager for Claude Code installation (comes with nodejs)
- **curl** - For downloading Claude Code installer script and making API calls
- **openssh-server** - Required for SSH access to the container

#### Development Tools
- **git** - For version control operations
- **jq** - For JSON parsing in scripts
- **make** - For build automation
- **vim** - Basic text editor for debugging/inspection
- **ripgrep** - Fast search tool (Claude Code may use this)

#### Python
- **python3** - Python 3.12.3 (default in Ubuntu 24.04)
- **python-is-python3** - Optional symlink for /usr/bin/python compatibility

#### Documentation Tools
- **ruby** - Runtime for Asciidoctor (Ruby 3.2 in Ubuntu 24.04)
- **ruby-dev** - Ruby development headers for native gem extensions
- **build-essential** - Compiler toolchain for building Ruby native extensions
- **asciidoctor** - Modern AsciiDoc to HTML/PDF processor (installed via gem)

#### HTML Processing Tools
- **tidy** - Classic HTML formatter and validator
- **html-minifier** - Node.js-based HTML minification tool (installed via npm)
- **prettier** - Multi-language code formatter with HTML support (installed via npm)
- **htmlhint** - HTML linter for validation (installed via npm)

Note: Python 3.11 specifically is not available in Ubuntu 24.04 default repositories at this time.

### Package Installation
Following the established style guide with inline comments:
```dockerfile
RUN apt-get update && apt-get install -y                                                 \
    «package-xxx»       `# «rationale-xxx»`                                              \
    «package-yyy»       `# «rationale-yyy»`                                              \
    «package-zzz»       `# «rationale-zzz»`                                              \
    && rm -rf /var/lib/apt/lists/*
```

### Image Configuration

1. Create non-root user `claude` with home directory, using configurable UID/GID via build arguments (default 1000:1000) to match host filesystem permissions
2. Set empty password for user `claude` to enable passwordless authentication
3. Generate SSH host keys during build rather than at runtime
4. Configure SSH daemon to listen on port 22 (mapped to 8888 externally), disable root login, and accept empty passwords
5. Configure PAM with permissive authentication for reliable passwordless SSH access
6. Download and install Claude Code using official installer script from `https://claude.ai/install.sh`, pinned to version 1.0.89 (released August 22, 2025)
7. Install Claude Code to `/usr/local/bin/claude-code` with executable permissions
8. Set working directory to `/workspace` for all container operations
10. Copy entrypoint script from build context to handle SSH daemon startup, Claude Code verification, and environment variable export
11. Configure container to run processes as root to support SSH daemon, with automatic user switching to `claude` upon SSH login

Note: Initial Claude Code authentication and setup is manual and out of scope for the Docker build. Container processes run as root to support SSH daemon operation.

### Entrypoint

This is a distinct file found in the build context, not generated by Dockerfile.

- Copy `entrypoint.sh` from build context using COPY instruction
- Custom entrypoint script to:
  - Start SSH daemon
  - Verify Claude Code installation
  - Set up environment variables
  - Keep container running

## Docker Compose Requirements

### Service Configuration
The service `claudecodebox` requires:
- Container name: ClaudeCodeBox
- Build context: ./build-context directory with Dockerfile
- Build arguments: USER_UID and USER_GID (default 1000) for filesystem permission alignment with host
- Port mapping: Host port 8888 to container SSH port 22
- Environment file: ../secrets/CCBX_CLAUDE.env containing ANTHROPIC_API_KEY

### Volume Mounts
- Workspace: Bind mount ../../../ to /workspace (parent of repo directory)
- Claude config: ./CLAUDE.md to /workspace/MyRepo/CLAUDE.md
- Named volumes for persistence:
  - claude-config: Mount to /home/claude/.claude
  - claude-cache: Mount to /home/claude/.cache

### Network Configuration
- Use bridge network named `claude-network`
- Allow external internet access for API calls

## Security Considerations
- Container network is internal-only (not exposed beyond host)
- SSH accessible only via localhost:8888
- Passwordless SSH is explicitly required and acceptable given internal-only access - this is a deliberate design choice for friction-free development within the isolated container environment
- API key stored in ../secrets/CCBX_CLAUDE.env

## Volume Persistence
- Claude configuration: Named volume `claude-config`
- Claude cache: Named volume `claude-cache`
- Workspace: Bind mount to host filesystem (parent of repo)

## Platform Compatibility
- Use relative paths in docker-compose.yml
- Path separators handled by Docker
- Works on Windows, macOS, and Linux hosts
