{
  "steps": [
    {
      "name": "gcr.io/cloud-builders/gcloud",
      "id": "derive-tag-base",
      "entrypoint": "bash",
      "args": [
        "-lc",
        "set -euo pipefail\n# Generate TAG_BASE from current UTC time (compact format)\nTAG_BASE=\"$$(date -u +%Y%m%dT%H%M%SZ)\"\ntest -n \"$${TAG_BASE}\" || (echo \"TAG_BASE empty\" >&2; exit 1)\necho \"$${TAG_BASE}\" > .tag_base\n"
      ]
    },
    {
      "name": "gcr.io/cloud-builders/gcloud",
      "id": "auth-docker-to-gar",
      "entrypoint": "bash",
      "args": [
        "-lc",
        "set -euo pipefail\ngcloud auth configure-docker \"${_RBGY_GAR_LOCATION}-docker.pkg.dev\" --quiet\n"
      ]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "buildx-create",
      "entrypoint": "bash",
      "args": [
        "-lc",
        "set -euo pipefail\ndocker buildx create --name rbia-builder --driver docker-container --use\ndocker buildx inspect --bootstrap\n"
      ]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "build-and-push",
      "entrypoint": "bash",
      "args": [
        "-lc",
        "set -euo pipefail\n# Required inputs\ntest -n \"${_RBGY_DOCKERFILE}\"     || (echo \"_RBGY_DOCKERFILE missing\"     >&2; exit 1)\ntest -n \"${_RBGY_MONIKER}\"        || (echo \"_RBGY_MONIKER missing\"        >&2; exit 1)\ntest -n \"${_RBGY_PLATFORMS}\"      || (echo \"_RBGY_PLATFORMS missing\"      >&2; exit 1)\ntest -n \"${_RBGY_GAR_LOCATION}\"   || (echo \"_RBGY_GAR_LOCATION missing\"   >&2; exit 1)\ntest -n \"${_RBGY_GAR_PROJECT}\"    || (echo \"_RBGY_GAR_PROJECT missing\"    >&2; exit 1)\ntest -n \"${_RBGY_GAR_REPOSITORY}\" || (echo \"_RBGY_GAR_REPOSITORY missing\" >&2; exit 1)\ntest -s .tag_base                  || (echo \"tag base not derived\"         >&2; exit 1)\ntest -n \"${_RBGY_GIT_COMMIT}\"     || (echo \"_RBGY_GIT_COMMIT missing\"     >&2; exit 1)\ntest -n \"${_RBGY_GIT_BRANCH}\"     || (echo \"_RBGY_GIT_BRANCH missing\"     >&2; exit 1)\ntest -n \"${_RBGY_GIT_REPO}\"       || (echo \"_RBGY_GIT_REPO missing\"       >&2; exit 1)\n\nTAG_BASE=\"$$(cat .tag_base)\"\nIMAGE_URI=\"${_RBGY_GAR_LOCATION}-docker.pkg.dev/${_RBGY_GAR_PROJECT}/${_RBGY_GAR_REPOSITORY}/${_RBGY_MONIKER}:$${TAG_BASE}-img\"\n# Convert space-separated platforms to comma-separated for docker buildx\nPLATFORMS_CSV=\"$${_RBGY_PLATFORMS// /,}\"\n\n: > build.log\nrun() { echo \"\\$$ $$* \" >> build.log; \"$$@\" >> build.log 2>&1; }\n\nrun docker buildx version\nrun docker version\nrun docker info\n\nrun docker buildx build \\\n  --platform=\"$${PLATFORMS_CSV}\" \\\n  --tag \"$${IMAGE_URI}\" \\\n  --push \\\n  --label \"moniker=${_RBGY_MONIKER}\" \\\n  --label \"git.commit=${_RBGY_GIT_COMMIT}\" \\\n  --label \"git.branch=${_RBGY_GIT_BRANCH}\" \\\n  -f \"${_RBGY_DOCKERFILE}\" \\\n  .\n\necho \"$${IMAGE_URI}\" > .image_uri\n"
      ]
    },
    {
      "name": "${_RBGY_JQ_REF}",
      "id": "assemble-metadata",
      "entrypoint": "sh",
      "args": [
        "-c",
        "set -euo pipefail\ntest -s .tag_base || (echo \"tag base not derived\" >&2; exit 1)\nTAG_BASE=\"$$(cat .tag_base)\"\nIMG_URI=\"$$(cat .image_uri)\"\ncp \"${_RBGY_DOCKERFILE}\" recipe.txt\nTS=\"$$(date -u +%FT%TZ)\"\njq -n                                    \\\n  --arg tag_base  \"$${TAG_BASE}\"          \\\n  --arg image_uri \"$${IMG_URI}\"           \\\n  --arg moniker   \"${_RBGY_MONIKER}\"     \\\n  --arg repo      \"${_RBGY_GIT_REPO}\"    \\\n  --arg branch    \"${_RBGY_GIT_BRANCH}\"  \\\n  --arg commit    \"${_RBGY_GIT_COMMIT}\"  \\\n  --arg ts        \"$${TS}\"                \\\n  --arg platforms \"${_RBGY_PLATFORMS}\"   \\\n  '{\n    tag_base: $$tag_base,\n    image: { uri: $$image_uri },\n    moniker: $$moniker,\n    git: { repo: $$repo, branch: $$branch, commit: $$commit },\n    build: { timestamp: $$ts },\n    platforms: $$platforms\n  }' > build_info.json\n"
      ]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "sbom-and-summary",
      "entrypoint": "bash",
      "args": [
        "-lc",
        "set -euo pipefail\ntest -n \"${_RBGY_SYFT_REF}\" || (echo \"_RBGY_SYFT_REF missing\" >&2; exit 1)\nIMAGE_URI=\"$$(cat .image_uri)\"\ndocker run --rm \"${_RBGY_SYFT_REF}\" \"$${IMAGE_URI}\" -o json  > syft_analysis.json\ndocker run --rm \"${_RBGY_SYFT_REF}\" \"$${IMAGE_URI}\" -o table > package_summary.txt\n"
      ]
    },
    {
      "name": "gcr.io/cloud-builders/docker",
      "id": "build-and-push-metadata",
      "entrypoint": "bash",
      "args": [
        "-lc",
        "set -euo pipefail\ntest -s .tag_base || (echo \"tag base not derived\" >&2; exit 1)\nTAG_BASE=\"$$(cat .tag_base)\"\nMETA_URI=\"${_RBGY_GAR_LOCATION}-docker.pkg.dev/${_RBGY_GAR_PROJECT}/${_RBGY_GAR_REPOSITORY}/${_RBGY_MONIKER}:$${TAG_BASE}-meta\"\n\n{\n  echo 'FROM scratch'\n  echo 'LABEL org.opencontainers.image.title=\"rbia-metadata\"'\n  echo 'ADD build_info.json /build_info.json'\n  echo 'ADD syft_analysis.json /syft_analysis.json'\n  echo 'ADD package_summary.txt /package_summary.txt'\n  echo 'ADD recipe.txt /recipe.txt'\n} > Dockerfile.meta\n\ndocker build -f Dockerfile.meta -t \"$${META_URI}\" .\ndocker push \"$${META_URI}\"\n"
      ]
    }
  ],
  "options": {
    "logging": "CLOUD_LOGGING_ONLY",
    "machineType": "${_RBGY_MACHINE_TYPE}"
  },
  "timeout": "${_RBGY_TIMEOUT}",
  "substitutions": {
    "_RBGY_DOCKERFILE": "Dockerfile",
    "_RBGY_MONIKER": "rbia",
    "_RBGY_PLATFORMS": "linux/amd64",
    "_RBGY_GAR_LOCATION": "us-central1",
    "_RBGY_GAR_PROJECT": "your-project-id",
    "_RBGY_GAR_REPOSITORY": "your-repo",
    "_RBGY_GIT_COMMIT": "unknown",
    "_RBGY_GIT_BRANCH": "unknown",
    "_RBGY_GIT_REPO": "unknown",
    "_RBGY_MACHINE_TYPE": "E2_HIGHCPU_8",
    "_RBGY_TIMEOUT": "1200s",
    "_RBGY_JQ_REF": "",
    "_RBGY_SYFT_REF": ""
  }
}
