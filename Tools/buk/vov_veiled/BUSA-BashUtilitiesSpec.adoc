= Bash Utilities Specification
:doctype: book

// tag::mapping-section[]
//
// Category declarations:
// bust_:  Tabtarget (launcher naming vesture)
// busd:   Dispatch (non-terminal, tabtarget system umbrella)
// busdc_: Dispatch Colophon (routing identifier)
// busdf_: Dispatch Frontispiece (human-readable description)
// busdi_: Dispatch Imprint (embedded parameter/target specifier)
// busdm_: Dispatch Formulary (routing component)
// busdl_: Dispatch Launcher (bootstrap script)
// bukro_: Kit Regime Operation (kindle/validate/render)
// burc_:  Configuration Regime (project-level settings)
// burs_:  Station Regime (developer-level settings)
// burd_:  Dispatch Runtime (ephemeral state assembled during dispatch)
// bure_:  Environment Regime (ambient caller-supplied behavioral overrides)
//
// Variant patterns:
//   _s: plural form
//   _p: possessive form
//

// Tabtarget Vesture
:bust_tabtarget:        <<bust_tabtarget,Tabtarget Vesture>>

// Dispatch
:busdc_colophon:        <<busdc_colophon,Colophon>>
:busdc_colophon_s:      <<busdc_colophon,Colophons>>
:busdf_frontispiece:    <<busdf_frontispiece,Frontispiece>>
:busdf_frontispiece_s:  <<busdf_frontispiece,Frontispieces>>
:busdi_imprint:         <<busdi_imprint,Imprint>>
:busdi_imprint_s:       <<busdi_imprint,Imprints>>
:busdm_formulary:       <<busdm_formulary,Formulary>>
:busdm_formulary_s:     <<busdm_formulary,Formularies>>
:busdl_launcher:        <<busdl_launcher,Launcher>>
:busdl_launcher_s:      <<busdl_launcher,Launchers>>

// Axial Regime Terms (from AXLA — matching RBSA)
:axrg_assignment:                  <<axrg_assignment,Assignment>>
:axrg_assignment_s:                <<axrg_assignment,Assignments>>
:axrg_prefix:                      <<axrg_prefix,Regime Prefix>>
:axrg_regime:                      <<axrg_regime,Regime>>
:axrg_regime_s:                    <<axrg_regime,Regimes>>
:axrg_variable:                    <<axrg_variable,Regime Variable>>
:axrg_variable_s:                  <<axrg_variable,Regime Variables>>

// Axial Format Terms (from AXLA — matching RBSA)
:axf_bash:                         <<axf_bash,Bash Format>>

// BUK Regime Operation Terms
:bukro_kindle:                     <<bukro_kindle,BUK Kindle>>
:bukro_validate:                   <<bukro_validate,BUK Validate>>
:bukro_render:                     <<bukro_render,BUK Render>>

// BUK Regime Prefixes
:burc_prefix:                      <<burc_prefix,BURC_>>
:burs_prefix:                      <<burs_prefix,BURS_>>

// BURC Regime: Configuration (project-level BUK settings)
:burc_regime:                      <<burc_regime,BURC Regime>>
:burc_station_file:                <<burc_station_file,BURC_STATION_FILE>>
:burc_tabtarget_dir:               <<burc_tabtarget_dir,BURC_TABTARGET_DIR>>
:burc_tabtarget_delimiter:         <<burc_tabtarget_delimiter,BURC_TABTARGET_DELIMITER>>
:burc_tools_dir:                   <<burc_tools_dir,BURC_TOOLS_DIR>>
:burc_project_root:                <<burc_project_root,BURC_PROJECT_ROOT>>
:burc_managed_kits:                <<burc_managed_kits,BURC_MANAGED_KITS>>
:burc_temp_root_dir:               <<burc_temp_root_dir,BURC_TEMP_ROOT_DIR>>
:burc_output_root_dir:             <<burc_output_root_dir,BURC_OUTPUT_ROOT_DIR>>
:burc_log_last:                    <<burc_log_last,BURC_LOG_LAST>>
:burc_log_ext:                     <<burc_log_ext,BURC_LOG_EXT>>

// BURS Regime: Station (developer-level BUK settings)
:burs_regime:                      <<burs_regime,BURS Regime>>
:burs_log_dir:                     <<burs_log_dir,BURS_LOG_DIR>>

// BURD Regime: Dispatch Runtime (ephemeral dispatch state)
:burd_regime:                      <<burd_regime,BURD Regime>>
:burd_prefix:                      <<burd_prefix,BURD_>>

// BURD Groups
:burd_group_input:                 <<burd_group_input,Input Variables>>
:burd_group_computed:              <<burd_group_computed,Computed Variables>>
:burd_group_parsed:                <<burd_group_parsed,Parsed Variables>>

// BURD Input Variables
:burd_regime_file:                 <<burd_regime_file,BURD_REGIME_FILE>>
:burd_no_log:                      <<burd_no_log,BURD_NO_LOG>>
:burd_interactive:                 <<burd_interactive,BURD_INTERACTIVE>>
:burd_coordinator_script:          <<burd_coordinator_script,BURD_COORDINATOR_SCRIPT>>
:burd_launcher:                    <<burd_launcher,BURD_LAUNCHER>>
:burd_station_file:                <<burd_station_file,BURD_STATION_FILE>>
:burd_term_cols:                   <<burd_term_cols,BURD_TERM_COLS>>

// BURD Computed Variables
:burd_now_stamp:                   <<burd_now_stamp,BURD_NOW_STAMP>>
:burd_temp_dir:                    <<burd_temp_dir,BURD_TEMP_DIR>>
:burd_output_dir:                  <<burd_output_dir,BURD_OUTPUT_DIR>>
:burd_transcript:                  <<burd_transcript,BURD_TRANSCRIPT>>
:burd_git_context:                 <<burd_git_context,BURD_GIT_CONTEXT>>
:burd_log_last:                    <<burd_log_last,BURD_LOG_LAST>>
:burd_log_same:                    <<burd_log_same,BURD_LOG_SAME>>
:burd_log_hist:                    <<burd_log_hist,BURD_LOG_HIST>>

// BURD Parsed Variables
:burd_command:                     <<burd_command,BURD_COMMAND>>
:burd_target:                      <<burd_target,BURD_TARGET>>
:burd_cli_args:                    <<burd_cli_args,BURD_CLI_ARGS>>
:burd_token_1:                     <<burd_token_1,BURD_TOKEN_1>>
:burd_token_2:                     <<burd_token_2,BURD_TOKEN_2>>
:burd_token_3:                     <<burd_token_3,BURD_TOKEN_3>>
:burd_token_4:                     <<burd_token_4,BURD_TOKEN_4>>
:burd_token_5:                     <<burd_token_5,BURD_TOKEN_5>>

// BURE Regime: Environment (ambient caller-supplied behavioral overrides)
:bure_prefix:                      <<bure_prefix,BURE_>>
:bure_regime:                      <<bure_regime,BURE Regime>>
:bure_countdown:                   <<bure_countdown,BURE_COUNTDOWN>>
:bure_verbose:                     <<bure_verbose,BURE_VERBOSE>>
:bure_color:                       <<bure_color,BURE_COLOR>>

// end::mapping-section[]

== Overview

The Bash Utilities Specification defines the tabtarget dispatch system — the infrastructure for tab-completion-friendly launchers that route to kit formularies.

BUK invented tabtargets; BUK defines them.

For universal naming vocabulary (Cipher, Signet, Epithet, Inscription, Vesture), see VLS-VoxLiturgicalSpec.adoc.

== Tabtarget Vesture

[[bust_tabtarget]]
// ⟦axl_voices axo_entity⟧
{bust_tabtarget}::
Vesture for tabtarget launcher identifiers.
Defines how launcher scripts in `tt/` are named.
+
* signet_case: lowercase with hyphen (the colophon)
* separator: `.`
* epithet_case: PascalCase (the frontispiece)
* envelope: `.sh`
+
Pattern: `{colophon}.{frontispiece}[.{imprint}].sh`
+
Examples:
+
* `rbw-B.ConnectBottle.sh` — RBW workbench, ConnectBottle operation
* `rbw-B.ConnectBottle.nsproto.sh` — same, with imprint specifying target
* `jjw-.HeatMount.sh` — JJK workbench, HeatMount operation
* `buw-tt.LauncherList.sh` — BUK tabtarget testbench, LauncherList operation

== Dispatch

The dispatch vocabulary defines the tabtarget launcher system.
A
{busdl_launcher}
validates arguments and delegates to a
{busdm_formulary}.
The
{busdc_colophon}
identifies the routing path;
the
{busdf_frontispiece}
provides human-readable description;
the
{busdi_imprint}
embeds target parameters.

[[busdc_colophon]]
// ⟦axl_voices axt_string⟧
{busdc_colophon}::
The routing identifier in a tabtarget inscription.
A
{busdc_colophon}
determines which
{busdm_formulary}
handles the dispatch.
Includes the hyphen as part of its identity (e.g., `rbw-`, `buw-tt-`).
+
The
{busdc_colophon}
is the first component of the tabtarget pattern, before the first dot separator.
+
Examples:
+
* `rbw-` routes to RBW workbench
* `jjw-` routes to JJK workbench
* `buw-tt-` routes to BUK tabtarget testbench

[[busdf_frontispiece]]
// ⟦axl_voices axt_string⟧
{busdf_frontispiece}::
The human-readable description in a tabtarget inscription.
A
{busdf_frontispiece}
uses PascalCase and describes the operation.
+
Appears after the
{busdc_colophon}
and dot separator.
+
Examples: `Build`, `ConnectBottle`, `RunVVX`, `HeatMount`.

[[busdi_imprint]]
// ⟦axl_voices axt_string⟧
{busdi_imprint}::
An optional embedded parameter in a tabtarget inscription.
An
{busdi_imprint}
specifies a target, instance, or configuration variant.
+
Appears after a second dot separator following the
{busdf_frontispiece}.
+
Examples:
+
* `nsproto` in `rbw-B.ConnectBottle.nsproto.sh`
* `srjcl` in `rbw-B.ConnectBottle.srjcl.sh`

[[busdm_formulary]]
// ⟦axl_voices axo_entity⟧
{busdm_formulary}::
A component that routes
{busdc_colophon_s}
to implementations.
Each
{busdm_formulary}
registers handlers for a set of
{busdc_colophon_s}
and dispatches to the appropriate function.
+
Types:
+
* **Workbench** (`{prefix}w_workbench.sh`): Routes commands for a kit
* **Testbench** (`{prefix}t_testbench.sh`): Routes tests for a kit
+
A
{busdm_formulary}
is sourced by the
{busdl_launcher}
and provides the dispatch function.

[[busdl_launcher]]
// ⟦axl_voices axo_entity⟧
{busdl_launcher}::
A bootstrap script in the `tt/` directory that validates arguments and delegates to a
{busdm_formulary}.
A
{busdl_launcher}
is the entry point for tabtarget invocation.
+
Naming follows
{bust_tabtarget}:
`{colophon}.{frontispiece}[.{imprint}].sh`
+
Responsibilities:
+
* Parse
{busdc_colophon}
from own filename
* Validate required arguments
* Source the target
{busdm_formulary}
* Invoke the dispatched function

== Routing Behavior

=== Dispatch Flow

. User invokes launcher: `./tt/rbw-B.ConnectBottle.nsproto.sh`
. Launcher parses its filename to extract:
* {busdc_colophon}:
`rbw-B`
* {busdf_frontispiece}:
`ConnectBottle`
* {busdi_imprint}:
`nsproto`
. Launcher sources the appropriate
{busdm_formulary}
(`rbw_workbench.sh`)
. Formulary's dispatch function routes based on frontispiece
. Target function executes with imprint as parameter

=== Workbench Pattern

[source,bash]
----
# Tools/{kit}/{prefix}w_workbench.sh

{prefix}w_dispatch() {
    local frontispiece="$1"
    local imprint="$2"
    shift 2

    case "$frontispiece" in
        Build)          {prefix}w_build "$imprint" "$@" ;;
        ConnectBottle)  {prefix}w_connect_bottle "$imprint" "$@" ;;
        *)              buc_fatal "Unknown frontispiece: $frontispiece" ;;
    esac
}
----

=== Testbench Pattern

Testbenches follow the same pattern but route to test functions:

[source,bash]
----
# Tools/{kit}/{prefix}t_testbench.sh

{prefix}t_dispatch() {
    local frontispiece="$1"
    shift

    case "$frontispiece" in
        Unit)        {prefix}t_unit "$@" ;;
        Integration) {prefix}t_integration "$@" ;;
        *)           buc_fatal "Unknown test: $frontispiece" ;;
    esac
}
----

=== Colophon Conventions

{busdc_colophon_s}
follow a structure that encodes both kit identity and formulary type:

* `{cipher}-` — default workbench (e.g., `rbw-`, `jjw-`)
* `{cipher}-t-` — testbench (e.g., `buw-t-`, `jjw-t-`)
* `{cipher}-{variant}-` — specialized workbench (e.g., `rbw-B-` for bottle operations)

The trailing hyphen is always part of the colophon — it separates the routing prefix from the dot-delimited tabtarget components.

== Regime Configuration

BUK defines two
{axrg_regime_s}
for project and developer configuration.
{axrg_assignment_s}
use
{axf_bash}
format (shell variable assignment files that are sourced).

=== Regime Prefixes

[[burc_prefix]]
// ⟦axl_voices axrg_prefix⟧
{burc_prefix}::
Bash Utility Configuration Regime

[[burs_prefix]]
// ⟦axl_voices axrg_prefix⟧
{burs_prefix}::
Bash Utility Station Regime

[[bure_prefix]]
// ⟦axl_voices axrg_prefix⟧
{bure_prefix}::
Bash Utility Environment Regime

=== Kit Regime Operations

[[bukro_kindle]]
// ⟦axvr_kindle⟧
{bukro_kindle}::
Silent initialization of Bash Utility Kit regime state from
{axrg_assignment_s}.
Sets defaults, detects unexpected variables, builds derived structures.

[[bukro_validate]]
// ⟦axvr_validate⟧
{bukro_validate}::
Strict field validation for Bash Utility Kit
{axrg_regime_s}.
Checks all type and constraint requirements via buv_env_* validators.

[[bukro_render]]
// ⟦axvr_render⟧
{bukro_render}::
Diagnostic display of Bash Utility Kit
{axrg_regime}
state.

=== BURC Regime

[[burc_regime]]
// ⟦axvr_regime axf_bash axrd_file_sourced axrd_singleton⟧
{burc_regime}::
Configuration regime for project-level BUK settings.
BURC assignment files in `.buk/burc.env` define repository structure and tabtarget infrastructure.

[[burc_station_file]]
// ⟦axvr_variable axd_required axtu_path⟧
{burc_station_file}::
Path to the developer's personal
{burs_regime}
assignment file.

[[burc_tabtarget_dir]]
// ⟦axvr_variable axd_required axtu_path⟧
{burc_tabtarget_dir}::
Directory containing
{busdl_launcher}
scripts.

[[burc_tabtarget_delimiter]]
// ⟦axvr_variable axd_required axtu_string⟧
{burc_tabtarget_delimiter}::
Single-character token separator in
{bust_tabtarget}
inscriptions.

[[burc_tools_dir]]
// ⟦axvr_variable axd_required axtu_path⟧
{burc_tools_dir}::
Directory containing BUK utilities and project tool scripts.

[[burc_project_root]]
// ⟦axvr_variable axd_required axtu_path⟧
{burc_project_root}::
Path from assignment file location to the project root directory.

[[burc_managed_kits]]
// ⟦axvr_variable axd_required axtu_string⟧
{burc_managed_kits}::
Comma-separated list of kits managed by vvx.
At release time, determines which kits are built into the binary.
At install time, must exactly match the parcel's kit list.

[[burc_temp_root_dir]]
// ⟦axvr_variable axd_required axtu_path⟧
{burc_temp_root_dir}::
Root directory for BUK temporary files.

[[burc_output_root_dir]]
// ⟦axvr_variable axd_required axtu_path⟧
{burc_output_root_dir}::
Root directory for BUK command output files.

[[burc_log_last]]
// ⟦axvr_variable axd_required axtu_xname⟧
{burc_log_last}::
Filename stem for the most recent command execution log.

[[burc_log_ext]]
// ⟦axvr_variable axd_required axtu_xname⟧
{burc_log_ext}::
File extension for log files, without leading dot.

=== BURS Regime

[[burs_regime]]
// ⟦axvr_regime axf_bash axrd_file_sourced axrd_singleton⟧
{burs_regime}::
Configuration regime for developer-level BUK settings.
BURS assignment files are personal to each developer and not committed to version control.

[[burs_log_dir]]
// ⟦axvr_variable axd_required axtu_path⟧
{burs_log_dir}::
Directory where this developer stores BUK operation logs.

=== BURD Regime

[[burd_prefix]]
// ⟦axl_voices axrg_prefix⟧
{burd_prefix}::
Bash Utility Dispatch Runtime

[[burd_regime]]
// ⟦axvr_regime axf_bash axrd_constructed axrd_singleton⟧
{burd_regime}::
Ephemeral runtime state assembled by bud_dispatch.sh during tabtarget execution.
Unlike file-sourced regimes, BURD variables are constructed inline — no assignment file exists.
The dispatch main function IS the kindle: zbud_setup sources configuration and derives computed state, zbud_process_args parses the tabtarget into tokens.

==== Input Variables

[[burd_group_input]]
// ⟦axl_voices axhrgb_group⟧
{burd_group_input}::
Variables set by the caller before dispatch invocation.

[[burd_regime_file]]
// ⟦axl_voices axrg_variable axtu_path⟧
{burd_regime_file}::
Path to the BURC regime assignment file to source during setup.

[[burd_no_log]]
// ⟦axl_voices axrg_variable axtu_string axd_optional⟧
{burd_no_log}::
When non-empty, suppresses all log file creation and output.

[[burd_interactive]]
// ⟦axl_voices axrg_variable axtu_string axd_optional⟧
{burd_interactive}::
When non-empty, enables interactive mode with uncurated tee logging.

[[burd_coordinator_script]]
// ⟦axl_voices axrg_variable axtu_path axd_required⟧
{burd_coordinator_script}::
Path to the coordinator script (workbench/testbench) that handles the dispatched command.

[[burd_launcher]]
// ⟦axl_voices axrg_variable axtu_path axd_required⟧
{burd_launcher}::
Path to the launcher bootstrap script, set by the tabtarget before exec.

[[burd_station_file]]
// ⟦axl_voices axrg_variable axtu_path axd_required⟧
{burd_station_file}::
Absolute path to the developer's station regime assignment file.
Set by the launcher from BURC_STATION_FILE.

[[burd_term_cols]]
// ⟦axl_voices axrg_variable axtu_integer⟧
{burd_term_cols}::
Terminal column width at dispatch time.
Detected from stty if available, defaults to 80.

==== Computed Variables

[[burd_group_computed]]
// ⟦axl_voices axhrgb_group⟧
{burd_group_computed}::
Variables derived during dispatch setup.

[[burd_now_stamp]]
// ⟦axl_voices axrg_variable axtu_string⟧
{burd_now_stamp}::
Unique timestamp combining date, time, PID, and random component.

[[burd_temp_dir]]
// ⟦axl_voices axrg_variable axtu_path⟧
{burd_temp_dir}::
Ephemeral directory for this dispatch invocation.

[[burd_output_dir]]
// ⟦axl_voices axrg_variable axtu_path⟧
{burd_output_dir}::
Fixed output directory cleared and recreated on each dispatch.

[[burd_transcript]]
// ⟦axl_voices axrg_variable axtu_path⟧
{burd_transcript}::
Path to the transcript file within the temporary directory.

[[burd_git_context]]
// ⟦axl_voices axrg_variable axtu_string⟧
{burd_git_context}::
Git describe output capturing repository state at dispatch time.

[[burd_log_last]]
// ⟦axl_voices axrg_variable axtu_path⟧
{burd_log_last}::
Path to the "last" log file, overwritten each dispatch.

[[burd_log_same]]
// ⟦axl_voices axrg_variable axtu_path⟧
{burd_log_same}::
Path to the curated "same" log file for the command+target combination.

[[burd_log_hist]]
// ⟦axl_voices axrg_variable axtu_path⟧
{burd_log_hist}::
Path to the timestamped historical log file.

==== Parsed Variables

[[burd_group_parsed]]
// ⟦axl_voices axhrgb_group⟧
{burd_group_parsed}::
Variables extracted from the tabtarget filename during argument processing.

[[burd_command]]
// ⟦axl_voices axrg_variable axtu_string⟧
{burd_command}::
Primary command token (first token from tabtarget split).

[[burd_target]]
// ⟦axl_voices axrg_variable axtu_string⟧
{burd_target}::
Complete tabtarget string as received by dispatch.

[[burd_cli_args]]
// ⟦axl_voices axrg_variable axtu_string axd_repeated⟧
{burd_cli_args}::
Array of additional CLI arguments passed after the tabtarget.

[[burd_token_1]]
// ⟦axl_voices axrg_variable axtu_string⟧
{burd_token_1}::
Positional token 1 from tabtarget split (the colophon).

[[burd_token_2]]
// ⟦axl_voices axrg_variable axtu_string⟧
{burd_token_2}::
Positional token 2 from tabtarget split (the frontispiece).

[[burd_token_3]]
// ⟦axl_voices axrg_variable axtu_string⟧
{burd_token_3}::
Positional token 3 from tabtarget split (the imprint, if present).

[[burd_token_4]]
// ⟦axl_voices axrg_variable axtu_string⟧
{burd_token_4}::
Positional token 4 from tabtarget split.

[[burd_token_5]]
// ⟦axl_voices axrg_variable axtu_string⟧
{burd_token_5}::
Positional token 5 from tabtarget split.

=== BURE Regime

[[bure_regime]]
// ⟦axvr_regime axf_bash axrd_constructed axrd_singleton⟧
{bure_regime}::
Ambient regime for caller-supplied behavioral overrides to BUK primitives.
Unlike file-sourced regimes, BURE variables are set directly in the caller's environment.
Kindled and validated when buc_command.sh is sourced.

[[bure_countdown]]
// ⟦axvr_variable axtu_string axd_optional⟧
{bure_countdown}::
Countdown behavior override.
When set to `skip`, buc_countdown bypasses interactive countdown and tty output.
When unset, countdown proceeds normally with interactive tty cancel window.
Any other value fails validation.

[[bure_verbose]]
// ⟦axl_voices axrg_variable axtu_integer⟧
{bure_verbose}::
Verbosity level controlling diagnostic output.
0=silent, 1=show messages, 2=enable bash trace.

[[bure_color]]
// ⟦axl_voices axrg_variable axtu_string⟧
{bure_color}::
Color output policy.
Input as auto/0/1; resolved to 0 or 1 during dispatch.
Respects NO_COLOR environment convention.

include::BUSD-DispatchRuntime.adoc[]
