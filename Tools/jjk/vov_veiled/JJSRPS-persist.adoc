Persist
{jjdgr_gallops}
state and commit changes to git with a JJ-aware commit message.
This routine combines
{jjdr_save}
with git commit operations to maintain the journalling discipline.
Used by most write operations to ensure every
{jjdgr_gallops}
mutation is tracked in git history.

{jjds_arguments}

// ⟦axd_required⟧
* lock (lock handle) — acquired lock from `vvg_lock_acquire`

// ⟦axd_required⟧
*
{jjdgr_gallops}
(in-memory structure to persist)

// ⟦axd_required⟧
* {jjda_file}

// ⟦axd_required⟧
* identity —
{jjdt_firemark}
for heat-level operations or
{jjdt_coronet}
for pace-level operations

// ⟦axd_required⟧
* message — commit message subject (without JJ prefix or Co-Authored-By)

// ⟦axd_required⟧
* size_limit — maximum commit size in bytes for size guard check

{jjds_behavior}

.
{jjdr_save}
{jjdgr_gallops}
to
{jjda_file}
. Stage gallops file with `git add {file}`
. If paddock file exists for this identity, stage it with `git add {paddock_file}`
. Run size guard check with provided size_limit
. Determine action code:
.. If identity is
{jjdt_firemark}:
extract from message prefix (`N:`, `S:`, `r:`, `T:`, `D:`, `R:`)
.. If identity is
{jjdt_coronet}:
extract from message prefix (`n:`, `A:`, `W:`, `F:`, `d:`)
. Format full commit message: `jjb:HALLMARK:IDENTITY:ACTION: message\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>`
. Run `git commit -m "..."`
. Return commit hash

{jjds_stdout} Commit hash (returned to caller)

{jjds_exit_uniform} 0 success, non-zero on error.

*Commands that use
{jjdr_persist}:*

*
{jjdo_create}
— creates new heat with action `N`
*
{jjdo_enroll}
— adds new pace with action `S`
*
{jjdo_reorder}
— reorders paces with action `r`
*
{jjdo_revise_docket},
{jjdo_arm},
{jjdo_relabel},
{jjdo_drop}
— add new tack with action `T`
*
{jjdo_relocate}
— moves pace between heats with action `D`
*
{jjdo_alter}
— changes heat status (action varies)

*Commands that do NOT use
{jjdr_persist}:*

*
{jjdo_archive}
— uses custom commit logic for trophy archival (stages trophy file, gallops, and paddock deletion; uses 200KB limit)
*
{jjdo_mark}
— creates empty commits only, no gallops changes
*
{jjdo_record}
— commits work artifacts, not gallops state

*Design rationale:*
{jjdr_persist}
ensures consistent commit message formatting and git discipline across all
{jjdgr_gallops}
mutations.
By centralizing the commit logic, we guarantee that every state change is properly journalled with parseable commit messages for
{jjdo_log}
to reconstruct steeplechase history.
