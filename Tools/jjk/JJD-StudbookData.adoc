= Job Jockey Studbook Data Model
:doctype: book

// tag::mapping-section[]
//
// Category declarations:
// jjdt_:  Types (scalar value types with validation rules)
// jjdsr_: Studbook record
// jjdsm_: Studbook members
// jjdhr_: Heat record
// jjdhm_: Heat members
// jjdhe_: Heat enum values (status)
// jjdpr_: Pace record
// jjdpm_: Pace members
// jjdpe_: Pace enum values (state)
// jjdkr_: Tack record
// jjdkm_: Tack members
// jjdo_:  Operations
// jjdz_:  Serialization concerns
//
// Variant patterns:
//   _s: plural form
//   _p: possessive form
//

// Types
:jjdt_coronet:    <<jjdt_coronet,Coronet>>
:jjdt_coronet_p:  <<jjdt_coronet,Coronet's>>
:jjdt_coronet_s:  <<jjdt_coronet,Coronets>>
:jjdt_favor:      <<jjdt_favor,Favor>>
:jjdt_favor_s:    <<jjdt_favor,Favors>>
:jjdt_firemark:   <<jjdt_firemark,Firemark>>
:jjdt_firemark_p: <<jjdt_firemark,Firemark's>>
:jjdt_firemark_s: <<jjdt_firemark,Firemarks>>
:jjdt_silks:      <<jjdt_silks,Silks>>

// Studbook record and members
:jjdsm_seed:        <<jjdsm_seed,next_heat_seed>>
:jjdsr_studbook:    <<jjdsr_studbook,Studbook>>
:jjdsr_studbook_p:  <<jjdsr_studbook,Studbook's>>

// Heat record and members
:jjdhe_current:   <<jjdhe_current,current>>
:jjdhe_retired:   <<jjdhe_retired,retired>>
:jjdhm_created:   <<jjdhm_created,creation_time>>
:jjdhm_firemark:  <<jjdhm_firemark,firemark>>
:jjdhm_order:     <<jjdhm_order,order>>
:jjdhm_silks:     <<jjdhm_silks,silks>>
:jjdhm_status:    <<jjdhm_status,status>>
:jjdhr_heat:      <<jjdhr_heat,Heat>>
:jjdhr_heat_p:    <<jjdhr_heat,Heat's>>
:jjdhr_heat_s:    <<jjdhr_heat,Heats>>

// Pace record and members
:jjdpe_abandoned: <<jjdpe_abandoned,abandoned>>
:jjdpe_complete:  <<jjdpe_complete,complete>>
:jjdpe_current:   <<jjdpe_current,current>>
:jjdpe_pending:   <<jjdpe_pending,pending>>
:jjdpm_coronet:   <<jjdpm_coronet,coronet>>
:jjdpm_silks:     <<jjdpm_silks,silks>>
:jjdpm_state:     <<jjdpm_state,state>>
:jjdpr_pace:      <<jjdpr_pace,Pace>>
:jjdpr_pace_p:    <<jjdpr_pace,Pace's>>
:jjdpr_pace_s:    <<jjdpr_pace,Paces>>

// Tack record and members
:jjdkm_refined:   <<jjdkm_refined,ts>>
:jjdkm_text:      <<jjdkm_text,text>>
:jjdkr_tack:      <<jjdkr_tack,Tack>>
:jjdkr_tack_p:    <<jjdkr_tack,Tack's>>
:jjdkr_tack_s:    <<jjdkr_tack,Tacks>>

// Arguments
:jjda_file:           <<jjda_file,--file>>

// Operations
:jjdo_current_pace:   <<jjdo_current_pace,Current Pace>>
:jjdo_current_tack:   <<jjdo_current_tack,Current Tack>>
:jjdo_heat_exists:    <<jjdo_heat_exists,Heat Exists>>
:jjdo_muster:         <<jjdo_muster,Muster>>
:jjdo_nominate:       <<jjdo_nominate,Nominate>>
:jjdo_rail:           <<jjdo_rail,Rail>>
:jjdo_reslate:        <<jjdo_reslate,Reslate>>
:jjdo_retire_extract: <<jjdo_retire_extract,Retire Extract>>
:jjdo_slate:          <<jjdo_slate,Slate>>
:jjdo_tally:          <<jjdo_tally,Tally>>
:jjdo_validate:       <<jjdo_validate,Validate>>

// Serialization
:jjdz_charset:  <<jjdz_charset,Charset>>
:jjdz_encoding: <<jjdz_encoding,Favor Encoding>>

// end::mapping-section[]

== Overview

The
{jjdsr_studbook}
is the persistent data store for Job Jockey.
It tracks
{jjdhr_heat_s}
(bounded initiatives) and their constituent
{jjdpr_pace_s}
(discrete actions).
Each
{jjdpr_pace}
maintains a history of
{jjdkr_tack_s}
(plan refinements).

== Design Principles

=== Exclusive JSON Ownership

All access to the
{jjdsr_studbook}
goes through jjr, the Rust CLI filter.
No jq or direct JSON manipulation ever touches this data.
This is an absolute architectural constraint, not a preference.

The rationale: writing reliable bash with jq pipelines requires fighting LLM training data.
The internet is full of bad bash.
Rust replaces fragile jq invocations with compiler-enforced correctness.
The compiler is tireless; humans are not.

=== Git as Journal

The
{jjdsr_studbook}
remains JSON specifically so git can serve as the journalling layer.
Every mutation creates a diffable commit.
Git owns the complete history; we need not implement our own audit trail.

The
{jjdkr_tack}
history within each
{jjdpr_pace}
exists for convenient postmortem analysis.
Git has the full history, but
{jjdkr_tack_s}
let us see plan evolution without spelunking commits.

=== Diff-Friendly Mutations

New
{jjdkr_tack_s}
prepend to position 0 rather than append.
This produces cleaner git diffs: prepending adds a line with trailing comma, while appending would modify the previous last line to add a comma.
Small discipline, large cumulative benefit.

The
{jjdhm_order}
array contains full Pace
{jjdt_favor_s}
despite the redundant
{jjdt_firemark}
prefix.
This redundancy is cheap and enables grep, copy-paste, and self-documenting JSON.

=== Crash-Safe Architecture

Bash handles locking via `git update-ref`.
jjr owns all
{jjdsr_studbook}
file access - reading, transforming, and writing.
jjr implements atomic writes internally (write to temp file, then rename).
If jjr crashes mid-transform, no partial writes occur.

The pattern:
[source,bash]
----
lock_acquire
jjr studbook nominate --file studbook.json "my-heat" "260111" || { lock_release; die; }
lock_release
----

This keeps bash simple (just locking and invocation) while jjr owns all JSON file operations.

=== Logical vs Serialized Identity

{jjdt_firemark}
and
{jjdt_coronet}
are the logical identities: simple integers.
{jjdt_favor}
is purely serialization: the base64-encoded, `₣`-prefixed string for JSON keys and human reference.

This separation keeps the Rust data model clean (integers) while providing readable external identifiers.
Encoding and decoding live in a well-defined serialization layer, not scattered through business logic.

=== Horse Racing Vocabulary

Job Jockey uses horse racing metaphors throughout.
This is intentional: vivid domain vocabulary helps humans hold complex systems in working memory.

* {jjdhr_heat} - a bounded initiative (like a race)
* {jjdpr_pace} - a discrete action (the rhythm of the race)
* {jjdkr_tack} - plan refinement (equipment; also "tacking" = adjusting course)
* {jjdt_firemark} - heat identity (hot-iron brand marking ownership)
* {jjdt_coronet} - pace identity (marking at the hoof line)
* {jjdt_silks} - display name (jockey's colors)
* {jjdt_favor} - external identifier (racing favor/token)
* {jjdsr_studbook} - the registry (breeding record book)

== Types

[[jjdt_firemark]]
// ⟦axl_voices axt_number⟧
{jjdt_firemark}::
An integer identifying a
{jjdhr_heat}.
Valid range: 0-4095 (2^12).
Serializes to 2 base64 characters in
{jjdt_favor}
encoding.

[[jjdt_coronet]]
// ⟦axl_voices axt_number⟧
{jjdt_coronet}::
An integer identifying a
{jjdpr_pace}
within its parent
{jjdhr_heat}.
Valid range: 0-262143 (2^18).
Serializes to 3 base64 characters in
{jjdt_favor}
encoding.

[[jjdt_silks]]
// ⟦axl_voices axt_string⟧
{jjdt_silks}::
A kebab-case display name.
Used for human-readable identification of
{jjdhr_heat_s}
and
{jjdpr_pace_s}.
Pattern: `[a-z0-9]+(-[a-z0-9]+)*`

[[jjdt_favor]]
// ⟦axl_voices axt_string⟧
{jjdt_favor}::
The serialized form of
{jjdt_firemark}
and
{jjdt_coronet}
used in JSON keys and external references.
Always prefixed with `₣`.
Heat
{jjdt_favor}
is 3 characters (`₣` + encoded
{jjdt_firemark}).
Pace
{jjdt_favor}
is 6 characters (`₣` + encoded
{jjdt_firemark}
+ encoded
{jjdt_coronet}).

== Records

=== {jjdsr_studbook}

[[jjdsr_studbook]]
// ⟦axl_voices axr_record_json⟧
{jjdsr_studbook}::
The root JSON structure containing all Job Jockey data.
Singleton record persisted at `.claude/jjm/jjd_studbook.json`.

==== Members

* [[jjdsm_seed]]
// ⟦axl_voices axr_member axd_required⟧
{jjdsm_seed}
is the next
{jjdt_firemark}
to allocate, stored as 2 base64 characters.
Incremented by
{jjdo_nominate}.

=== {jjdhr_heat}

[[jjdhr_heat]]
// ⟦axl_voices axr_record_json⟧
{jjdhr_heat}::
A bounded initiative with coherent goals.
Contains zero or more
{jjdpr_pace_s}
representing discrete actions.
Keyed in JSON by Heat
{jjdt_favor}.

==== Members

* [[jjdhm_firemark]]
// ⟦axl_voices axr_member axd_required⟧
{jjdhm_firemark}
is the
{jjdhr_heat_p}
primary key.
Type:
{jjdt_firemark}.
Implicit from JSON key; not stored as separate field.

* [[jjdhm_silks]]
// ⟦axl_voices axr_member axd_required⟧
{jjdhm_silks}
is the
{jjdhr_heat_p}
display name.
Type:
{jjdt_silks}.

* [[jjdhm_created]]
// ⟦axl_voices axr_member axd_required⟧
{jjdhm_created}
records when the
{jjdhr_heat}
was nominated.
Format: YYMMDD.

* [[jjdhm_status]]
// ⟦axl_voices axr_member axd_required⟧
{jjdhm_status}
indicates the
{jjdhr_heat_p}
lifecycle state.
Values:
{jjdhe_current}
or
{jjdhe_retired}.

* [[jjdhm_order]]
// ⟦axl_voices axr_member axd_required axd_repeated⟧
{jjdhm_order}
lists Pace
{jjdt_favor_s}
in execution sequence.
Array of 6-character strings.
May be reordered via
{jjdo_rail}.

==== Status Values

[[jjdhe_current]]
// ⟦axl_voices axt_enum_value⟧
{jjdhe_current}::
The
{jjdhr_heat}
is active and accepting work.

[[jjdhe_retired]]
// ⟦axl_voices axt_enum_value⟧
{jjdhe_retired}::
The
{jjdhr_heat}
is complete and archived.

=== {jjdpr_pace}

[[jjdpr_pace]]
// ⟦axl_voices axr_record_json⟧
{jjdpr_pace}::
A discrete action within a
{jjdhr_heat}.
Contains one or more
{jjdkr_tack_s}
representing plan refinements.
Keyed in JSON by Pace
{jjdt_favor}.

==== Members

* [[jjdpm_coronet]]
// ⟦axl_voices axr_member axd_required⟧
{jjdpm_coronet}
is the
{jjdpr_pace_p}
identity within its parent
{jjdhr_heat}.
Type:
{jjdt_coronet}.
Implicit from JSON key; not stored as separate field.

* [[jjdpm_silks]]
// ⟦axl_voices axr_member axd_required⟧
{jjdpm_silks}
is the
{jjdpr_pace_p}
display name.
Type:
{jjdt_silks}.

* [[jjdpm_state]]
// ⟦axl_voices axr_member axd_required⟧
{jjdpm_state}
indicates the
{jjdpr_pace_p}
progress.
Values:
{jjdpe_pending},
{jjdpe_current},
{jjdpe_complete},
or
{jjdpe_abandoned}.

==== State Values

[[jjdpe_pending]]
// ⟦axl_voices axt_enum_value⟧
{jjdpe_pending}::
The
{jjdpr_pace}
is queued but not yet started.

[[jjdpe_current]]
// ⟦axl_voices axt_enum_value⟧
{jjdpe_current}::
The
{jjdpr_pace}
is actively being worked.

[[jjdpe_complete]]
// ⟦axl_voices axt_enum_value⟧
{jjdpe_complete}::
The
{jjdpr_pace}
has been successfully finished.

[[jjdpe_abandoned]]
// ⟦axl_voices axt_enum_value⟧
{jjdpe_abandoned}::
The
{jjdpr_pace}
was stopped without completion.

=== {jjdkr_tack}

[[jjdkr_tack]]
// ⟦axl_voices axr_record_json⟧
{jjdkr_tack}::
A plan refinement entry for a
{jjdpr_pace}.
{jjdkr_tack_s}
form an append-only history.
Position 0 is the most recent; older
{jjdkr_tack_s}
follow.
New
{jjdkr_tack_s}
are prepended for cleaner git diffs.

==== Members

* [[jjdkm_refined]]
// ⟦axl_voices axr_member axd_required⟧
{jjdkm_refined}
records when this
{jjdkr_tack}
was added.
Format: YYMMDD-HHMM.

* [[jjdkm_text]]
// ⟦axl_voices axr_member axd_required⟧
{jjdkm_text}
contains the plan specification.
Non-empty string describing what the
{jjdpr_pace}
should accomplish.

== Serialization

[[jjdz_charset]]
{jjdz_charset}::
The 64-character alphabet for
{jjdt_favor}
encoding.
Characters: `A-Za-z0-9` plus two additional characters (TBD: confirm `-_` or other).
Position in charset determines numeric value (A=0, B=1, ...).

[[jjdz_encoding]]
{jjdz_encoding}::
The algorithm for converting between logical identities and
{jjdt_favor}
strings.
+
*Encoding:*
+
. Given
{jjdt_firemark}
F and
{jjdt_coronet}
C
. Encode F as 2 base64 digits: `charset[F/64]` + `charset[F%64]`
. Encode C as 3 base64 digits: `charset[C/4096]` + `charset[(C/64)%64]` + `charset[C%64]`
. Heat
{jjdt_favor}
= `₣` + encoded F
. Pace
{jjdt_favor}
= `₣` + encoded F + encoded C
+
*Decoding:*
+
. Strip `₣` prefix
. For Heat
{jjdt_favor}
(2 chars): F = pos(char1) * 64 + pos(char2)
. For Pace
{jjdt_favor}
(5 chars): extract F from first 2, C from last 3
. C = pos(char3) * 4096 + pos(char4) * 64 + pos(char5)

== Arguments

[[jjda_file]]
// ⟦axl_voices axa_argument axd_required⟧
{jjda_file}::
Path to the
{jjdsr_studbook}
JSON file.
Required by all operations.

== Operations

Operations are implemented in jjr.
jjr owns all
{jjdsr_studbook}
file access (read, transform, atomic write).
Bash handles locking via `git update-ref` and invokes jjr with
{jjda_file}.

=== Write Operations

[[jjdo_nominate]]
==== {jjdo_nominate}

Create a new
{jjdhr_heat}
with empty
{jjdpr_pace}
structure.

*Arguments:*
{jjda_file},
`silks` (kebab-case),
`created` (YYMMDD)

*Stdout:* New
{jjdhr_heat}
{jjdt_favor}

*Behavior:*

. Read
{jjdsr_studbook}
from file
. Read current
{jjdsm_seed}
as
{jjdt_firemark}
. Create new
{jjdhr_heat}
with:
.. Key: `₣` + encoded
{jjdt_firemark}
.. {jjdhm_silks}:
from argument
.. {jjdhm_created}:
from argument
.. {jjdhm_status}:
{jjdhe_current}
.. {jjdhm_order}:
empty array
.. `paces`: empty object
. Increment
{jjdsm_seed}
(base64 arithmetic with carry)
. Write transformed
{jjdsr_studbook}
to file (atomic)
. Output new
{jjdt_favor}
to stdout

[[jjdo_slate]]
==== {jjdo_slate}

Add a new
{jjdpr_pace}
to a
{jjdhr_heat}.

[[jjdo_reslate]]
==== {jjdo_reslate}

Add a new
{jjdkr_tack}
to a
{jjdpr_pace},
refining the plan.

[[jjdo_rail]]
==== {jjdo_rail}

Reorder
{jjdpr_pace_s}
within a
{jjdhr_heat}
by updating
{jjdhm_order}.

[[jjdo_tally]]
==== {jjdo_tally}

Update a
{jjdpr_pace_p}
{jjdpm_state}.

=== Read Operations

[[jjdo_validate]]
==== {jjdo_validate}

Check that
{jjdsr_studbook}
JSON conforms to schema.

*Arguments:*
{jjda_file}

*Stdout:* None

*Validation Rules:*

. Root must be JSON object with
{jjdsm_seed}
(2 base64 characters)
. Root must have `heats` object
. Each
{jjdhr_heat}
key must match `₣[A-Za-z0-9]{2}`
. Each
{jjdhr_heat}
must have:
{jjdhm_silks}
(non-empty kebab-case),
{jjdhm_created}
(YYMMDD),
{jjdhm_status}
({jjdhe_current}
or
{jjdhe_retired}),
{jjdhm_order}
(array),
`paces` (object)
. {jjdhm_order}
array and `paces` object must have identical key sets
. Each
{jjdpr_pace}
key must match `₣[A-Za-z0-9]{5}` and start with parent
{jjdhr_heat}
key
. Each
{jjdpr_pace}
must have:
{jjdpm_silks}
(non-empty kebab-case),
{jjdpm_state}
({jjdpe_pending},
{jjdpe_current},
{jjdpe_complete},
or
{jjdpe_abandoned}),
`tacks` (non-empty array)
. Each
{jjdkr_tack}
must have:
{jjdkm_refined}
(YYMMDD-HHMM),
{jjdkm_text}
(non-empty string)

[[jjdo_heat_exists]]
==== {jjdo_heat_exists}

Check whether a
{jjdhr_heat}
with given
{jjdt_favor}
exists.
Returns exit code 0 (exists) or 1 (not found).

[[jjdo_muster]]
==== {jjdo_muster}

List all
{jjdhr_heat_s}
with summary information.

[[jjdo_retire_extract]]
==== {jjdo_retire_extract}

Extract
{jjdhr_heat}
data for archival trophy.

[[jjdo_current_tack]]
==== {jjdo_current_tack}

Return the most recent
{jjdkr_tack_p}
{jjdkm_text}
for a given
{jjdpr_pace}.

[[jjdo_current_pace]]
==== {jjdo_current_pace}

Return the first
{jjdpr_pace}
in
{jjdhm_order}
whose
{jjdpm_state}
is
{jjdpe_pending}
or
{jjdpe_current}.
