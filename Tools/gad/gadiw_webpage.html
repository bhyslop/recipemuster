<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GAD Inspector</title>
    <link rel="stylesheet" href="gadic_cascade.css">
</head>
<body>
    <div class="status-section" id="statusSection"></div>

    <div class="workspace">
        <div class="rail-header">
            F <button class="swap-button" id="swapButton" title="Transpose rail positions">â‡„</button> T
        </div>

        <div class="render-header" id="comparisonHeader">
            <!-- Commit comparison will be displayed here -->
        </div>

        <div class="rail from" id="fromRail">
            <div id="fromRailContent">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <div class="rail to" id="toRail">
            <div id="toRailContent">
                <div class="loading">Loading...</div>
            </div>
        </div>

        <div class="rendered-pane" id="renderedPane">
            <div class="gadit-tab-bar" id="tabBar" style="display:none">
                <button class="gadit-prototype-tab" id="prototypeTab">Prototype</button>
                <button class="gadit-dual-tab" id="dualTab">Dual View</button>
            </div>
            <div id="tabContent">
                <div class="loading">Loading manifest...</div>
            </div>
        </div>
    </div>

    <div class="popover" id="commitPopover">
        <div class="popover-header">Commit Details</div>
        <div id="commitPopoverContent">
        </div>
    </div>

    <script type="module">
        // Use ESM import for modern diff-dom
        import { DiffDOM } from 'https://cdn.skypack.dev/diff-dom@5.2.0';
        window.diffDom = { DiffDOM };
        console.log('[DEBUG] diff-dom loaded via ESM:', typeof DiffDOM);
        // Trigger initialization if DOM is already ready
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => window.dispatchEvent(new Event('diff-dom-ready')));
        } else {
            window.dispatchEvent(new Event('diff-dom-ready'));
        }
    </script>
    <!-- Load modular GAD Inspector components in order -->
    <script src="gadib_base.js"></script>
    <script src="gadie_engine.js"></script>
    <script src="gadiu_user.js"></script>
    <script>
        // Initialize inspector when DOM and diff-dom are ready (GADS compliant initialization)
        let domReady = false;
        let diffDomReady = false;

        function checkInitialization() {
            if (domReady && diffDomReady) {
                console.log('[DEBUG] DOM and diff-dom ready, initializing modular inspector');
                console.log('[DEBUG]', `diff-dom available: ${typeof window.diffDom !== 'undefined'}`);
                if (typeof window.diffDom !== 'undefined') {
                    console.log('[DEBUG] diff-dom ESM loaded successfully');
                }
                // Use the modular gadiu_inspector class
                window.gadInspector = new window.gadiu_inspector();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            console.log('[DEBUG] DOM loaded, waiting for diff-dom ESM');
            domReady = true;
            checkInitialization();
        });

        window.addEventListener('diff-dom-ready', () => {
            console.log('[DEBUG] diff-dom ESM ready');
            diffDomReady = true;
            checkInitialization();
        });
    </script>
</body>
</html>