// RBSCO-CosmologyIntro.adoc
//
// Recipe Bottle Cosmology Overview â€” the nosebleed-terse "what this is"
//
// PURPOSE: This document is the index.html frontmatter source for the
// Recipe Bottle project page (scaleinv.github.io/recipebottle).
//
// ANCESTRY: Renamed from index.adoc (last committed 84323c31, 2025-08-18).
// Full git lineage: 31 commits from 2642121c through 84323c31.
//
// DEPENDENCY: Requires RBS0-SpecTop.adoc mapping section for attribute resolution.

== Overview

The
{at_rbm_system}
enables developers to safely run untrusted containers -
a significantly distinct use case than typical container deployments of carefully crafted code.

While containers excel at packaging known applications,
running third-party or experimental code poses security risks.
The
{at_rbm_system}
addresses this by interposing a security layer
({at_sentry_container})
between untrusted containers
({at_bottle_container_s})
and system resources,
without requiring modifications to existing container images.

This approach allows developers to leverage the vast ecosystem of containerized tools while maintaining strict security boundaries -
essential for small teams experimenting with diverse, potentially risky codebases.

== Current Challenges

GHCR violates OCI specification for reference counting, creating critical operational risk where deleting older container images may remove shared layers that newer images depend upon. GitHub Actions' shared runner environment enables cache poisoning attacks where multiple users share docker daemon access, making it unsafe for building containers from untrusted code.

The
{at_rbm_system}
will migrate to Google Cloud Build and Google Artifact Registry, which provide isolated build environments, SLSA Level 3 attestations, reference-counted layer management, native vulnerability scanning, and Binary Authorization for deploy-time verification.

Additionally, the project's build infrastructure currently relies on Makefiles, which limits portability. Converting to pure bash 3.2 implementation will ensure broader compatibility across development environments.

== The {at_rbm_system} Vision

.RBM System Architecture
image::rbm-abstract-drawio.svg[RBM Architecture,600,400,align="center"]

Maintaining build and service environments is a headache for the small development organization.
{st_container_s}
are an amazing tool for controlling package version constellations.
Necessary, but insufficient; I find that I need more redundancy, security, and control for my build setups.

The
{at_rbm_system}
is my answer for filling in the gaps.
The vision is simple: how can an
{at_operator}
run only a few apps natively on a
{at_workstation}
to coordinate and arrange
{st_container_s}
in sophisticated yet safe ways for me and my customer's work?

{at_rbm_system} uses only `bash`, `git`, `curl`, `openssh`, `jq` and a
{at_runtime}
(currently only `podman`) natively to produce a safe and controlled space for development involving
{st_container_s}
heavily.
{at_rbm_system}
itself is largely a set of bash scripts designed to be easily incorporated into arbitrary projects via
`git subtree`, `git subrepo`, or `git submodule`
graft.
This is purely an open-source undertaking.

=== Part One: {st_image} Management

The
{at_rbm_system}
streamlines
{st_image}
creation and curation through Google Cloud Build (GCB) and Google Artifact Registry (GAR).
The
{at_build_service}:

- Constructs
{st_image_s}
in clean, isolated environments using **Google-curated Cloud Build builder images**
- **Replicates trusted external images** into GAR with digest preservation and provenance tracking
- Supports multi-architecture builds via `docker buildx` with binfmt emulation
- Generates software bills of material for compliance
- Captures and stores full build transcripts for provenance
- Maintains build transcripts, SBOMs, and commit references in an **auxiliary metadata artifact** separate from the runtime image
- Stores validated
{st_image_s}
in Google Artifact Registry, tagged with minimal non-invasive labels

This dual approach - building custom images and importing vetted external ones - ensures all container images used in development have known provenance and consistent tagging.
Small teams can maintain a curated registry combining custom-built tools with carefully selected upstream images, all traceable through GAR's unified storage.

The system uses only
`curl`,
`jq`,
and
`bash`
scripts
to orchestrate both remote
{st_image}
construction and registry-to-registry replication, enabling small teams to maintain enterprise-grade
{st_image}
management practices without complex tooling.
`gcloud` is never required on the
{at_workstation};
it appears only inside Google-managed Cloud Build step containers (e.g. `gcr.io/cloud-builders/gcloud`) where it runs server-side during remote builds.

Auxiliary provenance data, including the SBOM (`syft_analysis.json`), build transcript, build configuration snapshot, and key package summaries, is bundled into a compressed archive and uploaded to GAR as a **Generic Artifact** using the image tag as the package name and a fixed `metadata` version identifier.
This design keeps the primary image minimal and broadly usable while making rich build history available to those who need it.

=== Part Two: {at_bottle_service} Orchestration

For development services requiring internet and/or IP connectivity at the
{at_workstation},
{at_rbm_system}
then orchestrates startup and configuration of
{at_bottle_service_s}, which are comprised of a
{at_sentry_container},
a
{at_censer_container},
and a
{at_bottle_container}
operating together.

The {at_rbm_system}
allows any
{st_image}
providing or using network services to function as a
{at_bottle_container}.
The
{at_censer_container}
establishes a privileged network namespace, configures it to route all traffic through the
{at_sentry_container},
then shares this pre-configured namespace with the
{at_bottle_container}.
This ensures security policies are enforced from the first packet, and the
{at_bottle_container}
experiences only a functional path to its
{at_sentry_container}
gateway.

The
{at_sentry_container}
thus sets up a potentially sophisticated set of network security safeguards that prevent malicious or compromised
{at_bottle_container_s}
from exfiltrating the
{at_operator_p}
assets.
Through configuration of deeply mature tools `iptables` and `dnsmasq`, the
{at_sentry_container}
prevents such illegal accesses.

By providing these controlled yet accessible tools, the
{at_rbm_system}
enables small development teams to maintain proper container hygiene throughout their workflow - from initial building through deployment and eventual cleanup.
This empowers organizations to leverage the expanding ecosystem of containerized development tools without requiring specialized DevOps expertise.

== Significant Events

// Deep spelunk helper: $ git log --remotes=origin --all --graph --name-status

[%header,cols="1,3"]
|===
| Date | Event

// | Feb 23, 2022
// | Got Docker ID.
// [cnmp:73066af]

| Dec 10, 2023
| First try at wrangling Docker in local cygwin environment.
// [cnmp:4009f87]

| Mar 18, 2024
| Embrace multiple ephemeral docker container images for single build.
// [cnmp:60f0cf2]

| Aug 7, 2024
| Started Jupyter Notebook in docker container.
// [cnmp:22d2fce]

| Aug 11, 2024
| Learned docker can't connect to host and internal network simultaneously.
// [cnmp:3b20684]

| Aug 17, 2024
| Switched to podman for better networking.
// [cnmp:3a47915]

| Sep 2, 2024
| First attempt to use asciidoc for concept models.

| Oct 7, 2024
| GitHub Action performed docker
{st_image}
build.

| Nov 2024
| Bespoke
{at_bottle_container}
images with custom networking use
{at_sentry_container}
networking via Claude curated requirements and script generation.

| Dec 2024
| Experiments to start unmodified
{at_bottle_container}
images using podman networking configurations fail.

| Dec 31, 2024
| Submitted Podman feature request https://github.com/containers/podman/issues/24920[issue #24920] for gateway feature.

| Jan 6, 2025
| Feature request https://github.com/containers/podman/issues/24920[issue #24920] rejected.

| Jan 2025
| Podman 5.2 VMs running unmodified
{at_bottle_container}
images using VM network namespace machinations.

| Feb 2025
| Podman 5.3 VM update breaks previous, and reversion to 5.2 fails due to reissued VM.  Podman VM tags determined not immutable.

| Mar 2025
| Developed full reproducibility scenarios and determined that VM network namespace approach no longer valid.

// | Apr 2025
// | Attempted podman-unshare approach to access network namespaces.

| June 25, 2025
| Attempting to use eBPF frame rewriting to bypass Netavark gateway behaviors lead to third container concept.

| July 3, 2025
| {at_censer_container}
as privileged network namespace configurator hosting unprivileged
{at_bottle_container}
functions; all
{at_sentry_container}/{at_bottle_container}
test cases pass again.

| July 27, 2025
| GHCR
{st_image}
deletions determined unsafe due to lack of OCI-specified reference counting on layers; deleting old images can destroy new ones.

|===
