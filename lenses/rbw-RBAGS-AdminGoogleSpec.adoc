= Recipe Bottle Google Specification
:toc:
:toc-title: Table of Contents
:sectnums:
:icons: font
:stylesheet: dark-theme.css
:stylesdir: .
:index:

// Begin Mapping Section
// tag::mapping-section[]

// Category declarations:
// rbtr_ prefix: RB Term Role (Recipe Bottle role identities)
// rbtgi_ prefix: RB Term Google Instance (Recipe Bottle specific instances)
// rbtgo_ prefix: RB Google Operation (Recipe Bottle workflows)
// gcp_ prefix: Google Cloud Platform (core infrastructure concepts)
// gar_ prefix: Google Artifact Registry (generic service)
// gcs_ prefix: Google Cloud Storage (generic service)
// gcb_ prefix: Google Cloud Build (generic service)
// giam_ prefix: Google Cloud Identity and Access Management
// rbrr_ prefix: Repository Regime configuration

// Cross-reference terms from RBS/Index:
// at_ prefix: Architectural Term (maintained for consistency)

// Variant patterns:
//   _s: plural form
//   _p: possessive form
//   _ed: past tense (verbs)
//   _ing: progressive form (verbs)

// RB Role Infrastructure
:rbtr_role:                  <<rbtr_role,RB Role>>
:rbtr_role_s:                <<rbtr_role,RB Roles>>

// Service Account Hierarchy
:rbtr_payor:                 <<rbtr_payor,Payor Role>>
:rbtr_governor:              <<rbtr_governor,Governor Role>>
:rbtr_mason:                 <<rbtr_mason,Mason Role>>
:rbtr_director:              <<rbtr_director,Director Role>>
:rbtr_retriever:             <<rbtr_retriever,Retriever Role>>
:rbtr_retriever_s:           <<rbtr_retriever,Retriever Roles>>

// Recipe Bottle Term Google Instances
:rbtgi_depot_project:        <<rbtgi_depot_project,RB Depot Project>>
:rbtgi_depot_project_s:      <<rbtgi_depot_project,RB Depot Projects>>
:rbtgi_payor_project:        <<rbtgi_payor_project,RB Payor Project>>
:rbtgi_build_bucket:         <<rbtgi_build_bucket,RB Build Bucket>>
:rbtgi_build_bucket_s:       <<rbtgi_build_bucket,RB Build Buckets>>
:rbtgi_repository:           <<rbtgi_repository,RB Container Repository>>
:rbtgi_repository_s:         <<rbtgi_repository,RB Container Repositories>>
:rbtgi_image:                <<rbtgi_image,RB Image>>
:rbtgi_image_s:              <<rbtgi_image,RB Images>>
:rbtgi_metadata:             <<rbtgi_metadata,RB Metadata Artifact>>
:rbtgi_metadata_s:           <<rbtgi_metadata,RB Metadata Artifacts>>
:rbtgi_rbra_file:            <<rbtgi_rbra_file,RBRA File>>
:rbtgi_rbra_file_s:          <<rbtgi_rbra_file,RBRA Files>>
:rbtgi_json_key_file:        <<rbtgi_json_key_file,JSON Key File>>
:rbtgi_json_key_file_s:      <<rbtgi_json_key_file,JSON Key Files>>
:rbtgi_depot:                <<rbtgi_depot,RB Depot>>

// Recipe Bottle Term Google Operations
:rbtgo_payor_establish:      <<rbtgo_payor_establish,rbgm_payor_establish>>
:rbtgo_payor_install:        <<rbtgo_payor_install,rbgp_payor_install>>
:rbtgo_depot_create:         <<rbtgo_depot_create,rbgp_depot_create>>
:rbtgo_depot_list:           <<rbtgo_depot_list,rbgp_depot_list>>
:rbtgo_depot_destroy:        <<rbtgo_depot_destroy,rbgp_depot_destroy>>
:rbtgo_governor_create:      <<rbtgo_governor_create,rbgp_governor_create>>
:rbtgo_retriever_create:     <<rbtgo_retriever_create,rbgg_retriever_create>>
:rbtgo_director_create:      <<rbtgo_director_create,rbgg_director_create>>
:rbtgo_sa_list:              <<rbtgo_sa_list,rbgs_list_service_accounts>>
:rbtgo_sa_delete:            <<rbtgo_sa_delete,rbgs_list_service_accounts>>
:rbtgo_trigger_build:        <<rbtgo_trigger_build,rbgo_trigger_build>>
:rbtgo_image_retrieve:       <<rbtgo_image_retrieve,Image Retrieval>>
:rbtgo_image_delete:         <<rbtgo_image_delete,Image Deletion>>
:rbtgo_payor_refresh:        <<rbtgo_payor_refresh,rbmp_payor_refresh>>
:rbtoe_oauth_refresh:        <<rbtoe_oauth_refresh,zrbgp_refresh_capture>>
:rbtoe_payor_authenticate:   <<rbtoe_payor_authenticate,zrbgp_authenticate_capture>>
:rbtoe_depot_list_update:    <<rbtoe_depot_list_update,Depot List Update Pattern>>

// Google Cloud Platform Core Concepts
:gcp_service:                <<gcp_service,Google Cloud>>
:gcp_organization:           <<gcp_organization,GCP Organization>>
:gcp_organization_s:         <<gcp_organization,GCP Organizations>>
:gcp_folder:                 <<gcp_folder,GCP Folder>>
:gcp_folder_s:               <<gcp_folder,GCP Folders>>
:gcp_project_number:         <<gcp_project_number,Project Number>>
:gcp_project_number_s:       <<gcp_project_number,Project Numbers>>
:gcp_project_id:             <<gcp_project_id,Project ID>>
:gcp_project_id_s:           <<gcp_project_id,Project IDs>>
:gcp_lro:                    <<gcp_lro,LRO>>
:gcp_lro_s:                  <<gcp_lro,LROs>>
:gcp_delete_requested:       <<gcp_delete_requested,DELETE_REQUESTED State>>
:gcp_billing_enabled:        <<gcp_billing_enabled,Billing Enabled Status>>

// Google Artifact Registry
:gar_service:                <<gar_service,Google Artifact Registry>>
:gar_registry:               <<gar_registry,Artifact Registry>>
:gar_registry_s:             <<gar_registry,Artifact Registries>>

// Google Cloud Storage
:gcs_service:                <<gcs_service,Google Cloud Storage>>
:gcs_bucket:                 <<gcs_bucket,Cloud Storage Bucket>>
:gcs_bucket_s:               <<gcs_bucket,Cloud Storage Buckets>>

// Google Cloud Build
:gcb_service:                <<gcb_service,Google Cloud Build>>
:gcb_service_s:              <<gcb_service,Google Cloud Builds>>
:gcb_service_p:              <<gcb_service,Google Cloud Build's>>
:gcb_build:                  <<gcb_build,Cloud Build>>
:gcb_build_s:                <<gcb_build,Cloud Builds>>

// Identity and Access Management
:giam_role:                  <<giam_role,IAM Role>>
:giam_role_s:                <<giam_role,IAM Roles>>
:giam_binding:               <<giam_binding,IAM Binding>>
:giam_binding_s:             <<giam_binding,IAM Bindings>>
:gcp_lien:                   <<gcp_lien,Lien>>
:gcp_lien_s:                <<gcp_lien,Liens>>
:giam_service_account:       <<giam_service_account,Service Account>>
:giam_service_account_s:     <<giam_service_account,Service Accounts>>

// Authentication
:oauth_token:                <<oauth_token,OAuth Token>>
:oauth_token_s:              <<oauth_token,OAuth Tokens>>

// Recipe Bottle Term Orchestration Embodiments (RB-specific patterns)
:rbtoe_rbra_generate:        <<rbtoe_rbra_generate,rbgu_extract_json_to_rbra>>
:rbtoe_rbra_load:            <<rbtoe_rbra_load,rbgu_rbra_load>>
:rbtoe_rbro_load:            <<rbtoe_rbro_load,rbgu_rbro_load>>
:rbtoe_jwt_oauth_exchange:   <<rbtoe_jwt_oauth_exchange,rbgo_get_token_capture>>
:rbtoe_api_enable:           <<rbtoe_api_enable,rbgu_api_enable>>

// Cross-referenced from existing specs
:at_recipe_bottle:           <<at_recipe_bottle,Recipe Bottle>>
:at_rbm_system:              <<at_rbm_system,Recipe Bottle Workbench>>
:at_bottle_image:            <<at_bottle_image,Bottle Image>>
:at_bottle_image_s:          <<at_bottle_image,Bottle Images>>
:at_user:                    <<at_user,User>>
:at_user_s:                  <<at_user,Users>>
:at_user_p:                  <<at_user,User's>>
:at_workstation:             <<at_workstation,Workstation>>
:at_workstation_p:           <<at_workstation,Workstation's>>
:at_base_utilities:          <<at_base_utilities,Base Utilities>>
:at_regime:                  <<at_regime,Configuration Regime>>
:at_regime_s:                <<at_regime,Configuration Regimes>>

// Recipe Bottle Regime: Repo (subset)
:rbrr_regime:                <<rbrr_regime,RBRR Regime>>
:rbrr_depot_project_id:      <<rbrr_depot_project_id,RBRR_DEPOT_PROJECT_ID>>
:rbrr_gcp_region:            <<rbrr_gcp_region,RBRR_GCP_REGION>>
:rbrr_gar_repository:        <<rbrr_gar_repository,RBRR_GAR_REPOSITORY>>
:rbrr_governor_rbra_file:    <<rbrr_governor_rbra_file,RBRR_GOVERNOR_RBRA_FILE>>
:rbrr_payor_rbra_file:       <<rbrr_payor_rbra_file,RBRR_PAYOR_RBRA_FILE>>
:rbrr_retriever_rbra_file:   <<rbrr_retriever_rbra_file,RBRR_RETRIEVER_RBRA_FILE>>
:rbrr_director_rbra_file:    <<rbrr_director_rbra_file,RBRR_DIRECTOR_RBRA_FILE>>

// Recipe Bottle Regime: Account (service account credentials)
:rbra_client_email:          <<rbra_client_email,RBRA_CLIENT_EMAIL>>
:rbra_private_key:           <<rbra_private_key,RBRA_PRIVATE_KEY>>
:rbra_project_id:            <<rbra_project_id,RBRA_PROJECT_ID>>

// Recipe Bottle Regime: Payor
:rbrp_payor_project_id:      <<rbrp_payor_project_id,RBRP_PAYOR_PROJECT_ID>>
:rbrp_billing_account_id:    <<rbrp_billing_account_id,RBRP_BILLING_ACCOUNT_ID>>
:rbrp_oauth_client_id:       <<rbrp_oauth_client_id,RBRP_OAUTH_CLIENT_ID>>
:rbrp_depot_project_ids:     <<rbrp_depot_project_ids,RBRP_DEPOT_PROJECT_IDS>>

// Recipe Bottle Regime: Payor
:rbrp_regime:                <<rbrp_regime,RBRP Regime>>

// Recipe Bottle Regime: OAuth (local OAuth credentials)
:rbro_regime:                <<rbro_regime,RBRO Regime>>
:rbro_client_secret:         <<rbro_client_secret,RBRO_CLIENT_SECRET>>
:rbro_refresh_token:         <<rbro_refresh_token,RBRO_REFRESH_TOKEN>>

// Recipe Bottle Regime: Vessel (container image specifications)
:rbrv_regime:                <<rbrv_regime,RBRV Regime>>

// Recipe Bottle Regime: Authentication (service account credentials)
:rbra_regime:                <<rbra_regime,RBRA Regime>>

// Recipe Bottle Regime: Environment Variables (runtime container configuration)
:rbev_regime:                <<rbev_regime,RBEV Regime>>

// Recipe Bottle Regime Prefixes
:rbrr_prefix:                <<rbrr_prefix,RBRR_>>
:rbrp_prefix:                <<rbrp_prefix,RBRP_>>
:rbro_prefix:                <<rbro_prefix,RBRO_>>
:rbrv_prefix:                <<rbrv_prefix,RBRV_>>
:rbra_prefix:                <<rbra_prefix,RBRA_>>
:rbev_prefix:                <<rbev_prefix,RBEV_>>

// RB Bash Console Control Terms (rbbc_* - voices axc_* in axe_bash_interactive)
:rbbc_variable:              <<rbbc_variable,VARIABLE>>
:rbbc_fatal:                 <<rbbc_fatal,FATAL>>
:rbbc_warn:                  <<rbbc_warn,WARN>>
:rbbc_store:                 <<rbbc_store,STORE>>
:rbbc_use:                   <<rbbc_use,USE>>
:rbbc_require:               <<rbbc_require,REQUIRE>>
:rbbc_poll:                  <<rbbc_poll,POLL>>
:rbbc_call:                  <<rbbc_call,CALL>>
:rbbc_submit:                <<rbbc_submit,SUBMIT>>
:rbbc_await:                 <<rbbc_await,AWAIT>>
:rbbc_show:                  <<rbbc_show,SHOW>>

// RB Human Guide Control Terms (rbhg_* - voices axc_* in axe_human_guide)
:rbhg_fatal:                 <<rbhg_fatal,STOP>>
:rbhg_warn:                  <<rbhg_warn,CAUTION>>
:rbhg_store:                 <<rbhg_store,RECORD>>
:rbhg_require:               <<rbhg_require,VERIFY>>
:rbhg_show:                  <<rbhg_show,NOTE>>

// end::mapping-section[]

== Google API Engagement

{at_recipe_bottle}
invokes
{gcp_service}
APIs through
{giam_service_account}
JWT authentication and direct HTTPS REST calls.

* *Authentication*:
{giam_service_account_s}
use private key credentials to sign JWTs with RS256.
These JWTs are exchanged for
{oauth_token_s}
via Google's token endpoint.
All API calls include the bearer token in the Authorization header.

* *Invocation Pattern*:
Operations execute through curl with JSON payloads and responses.
Each call captures both HTTP status codes and response bodies to files for processing.
Success is determined by HTTP 200/201/204 codes.

* *Long-Running Operations*:
{gcp_service}
{gcp_lro_s}
return operation IDs that must be polled until completion.
The system polls at configurable intervals until completion.
The system handles both success and error states.
Operations utilize
{rbbc_submit}
and
{rbbc_await}
to handle all asynchronous operations.

* *IAM Policies*:
All IAM policy modifications enforce version 3 to ensure conditional role binding support across all
{gcp_service}
resources.

== {rbtr_payor} Operations

[[rbtgo_payor_establish]]
// ⟦axl_voices axo_guide axe_human_guide⟧
=== {rbtgo_payor_establish}

The
{at_user}
performs one-time manual setup via Google Cloud Console to establish
{rbtr_payor}
OAuth infrastructure.
No API path exists for initial bootstrap - OAuth client creation requires human Console interaction.
This procedure creates the project and OAuth client but does NOT install credentials.

. *Create Payor Project*:
.. Navigate to project creation in Console
.. Set project name: `Recipe Bottle Payor`
.. Set project ID: `rbw-payor` (preferred fixed name, single payor per account)
.. If `rbw-payor` already exists, use `rbw-payor-[4-digit-suffix]` (e.g., rbw-payor-2024)
.. {rbhg_store} actual project ID as `«PAYOR_PROJECT_ID»` for subsequent operations

. *Configure Billing*:
.. Access billing management in Console
.. Select or create billing account
.. Record
{rbrp_billing_account_id}
(format: XXXXXX-XXXXXX-XXXXXX)
.. Link billing account to payor project
.. {rbhg_require} billing linkage for API operations

. *Enable Required APIs*:
.. Navigate to APIs & Services > Enable APIs
.. Enable: Cloud Resource Manager, Cloud Billing, Service Usage, IAM, Artifact Registry
.. These enable programmatic depot management

. *Configure OAuth Consent Screen*:
.. Navigate to APIs & Services > OAuth consent screen
.. Select "External" user type (no Google Workspace required)
.. Set Publishing Status: "Testing" (100 users sufficient)
.. Add scopes:
... https://www.googleapis.com/auth/cloud-platform
... https://www.googleapis.com/auth/cloud-billing
.. Add test users if needed

. *Create OAuth 2.0 Client ID*:
.. Navigate to APIs & Services > Credentials
.. Create credentials > OAuth client ID
.. Application type: Desktop application
.. Name: "Recipe Bottle Payor"
.. Download JSON as `payor-oauth.json`
.. {rbhg_warn} client secret non-recoverable after initial download

. *Update Configuration*:
.. Update `rbrp.env` with payor project values:
... `RBRP_PAYOR_PROJECT_ID=rbw-payor` (or chosen project ID)
... `RBRP_BILLING_ACCOUNT_ID=XXXXXX-XXXXXX-XXXXXX` (from step 2)

NOTE: OAuth JSON file created but not installed. Use
{rbtgo_payor_refresh}
to install credentials and complete setup.

[[rbtgo_payor_refresh]]
// ⟦axl_voices axo_guide axe_human_guide⟧
=== {rbtgo_payor_refresh}

Manual procedure to install OAuth credentials for new setup or refresh expired/compromised credentials.
Use this for both initial credential installation after
{rbtgo_payor_establish}
and for renewal operations.

. *Obtain OAuth Credentials*:
.. For initial setup: Use JSON file downloaded during
{rbtgo_payor_establish}
.. For refresh/renewal: Navigate to APIs & Services > Credentials in Payor Project
... Find existing "Recipe Bottle Payor" OAuth client
... Download new JSON (or regenerate secret if compromised)
... Save as `payor-oauth-[timestamp].json`

. *Install/Refresh Credentials*:
.. Run: `rbgp_payor_install /path/to/payor-oauth.json`
.. This will:
... Guide you through OAuth authorization flow
... Store secure credentials in `~/.rbw/rbro.env`
... Test the authentication
... Initialize depot tracking
... Update `RBRP_OAUTH_CLIENT_ID` in `rbrp.env`

. *Verify Installation*:
.. Test with: `rbgp_depot_list`
.. Should display current depots without authentication errors

NOTE: The credential installation functionality is now handled by {rbtgo_payor_refresh} procedure.
OAuth refresh tokens in testing mode expire after 6 months of non-use.

[[rbtgo_depot_create]]
// ⟦axl_voices axo_command axe_bash_interactive⟧
=== {rbtgo_depot_create}

NOTE: This operation creates an
{rbtgi_depot}
- a cohesive unit of Recipe Bottle infrastructure including the depot project, build bucket, container repository, and Mason service account that share their productive lifecycle.

The
{rbtr_payor}
creates a new depot infrastructure from the
{rbtgi_payor_project}:

. *Validate Input Parameters*:
.. {rbbc_require} `«INPUT_DEPOT_NAME»` provided as first argument
.. Validate depot name: lowercase letters, numbers, hyphens only, max 20 chars
.. {rbbc_require} `«INPUT_REGION»` provided as second argument
.. {rbbc_call} link:https://cloud.google.com/artifact-registry/docs/reference/rest/v1/projects.locations/list[artifactregistry.locations.list] to retrieve valid regions
.. {rbbc_require} `«INPUT_REGION»` exists in valid regions list
.. {rbbc_fatal} if invalid: "Invalid region. Valid regions: [list]"

. *Authenticate as
{rbtr_payor}*:
.. Execute
{rbtoe_payor_authenticate}

. *Generate Depot Project ID*:
.. {rbbc_store} `«TIMESTAMP»` as current time in YYYYMMDDHHmm format
.. Generate project ID: `rbw-«INPUT_DEPOT_NAME»-«TIMESTAMP»`
.. {rbbc_store} as `«DEPOT_PROJECT_ID»`
.. {rbbc_require} total length ≤ 30 characters

. *Create Depot Project*:
.. {rbbc_submit} link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/create[projects.create] with:
... projectId: `«DEPOT_PROJECT_ID»`
... displayName: `RB Depot: «INPUT_DEPOT_NAME»`
... parent: `{rbrp_parent_type}s/{rbrp_parent_id}` (if parent_type != `none`)
.. {rbbc_await} returned operation
.. {rbbc_require} project creation successful

. *Link Billing Account*:
.. {rbbc_call} link:https://cloud.google.com/billing/docs/reference/rest/v1/projects/updateBillingInfo[cloudbilling.projects.updateBillingInfo] for `«DEPOT_PROJECT_ID»`
.. Set billingAccountName: `billingAccounts/{rbrp_billing_account_id}`
.. {rbbc_require} HTTP 200 response confirming billing linkage

. *Get Depot Project Number*:
.. {rbbc_call} link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/get[projects.get] for `«DEPOT_PROJECT_ID»`
.. {rbbc_store} `«PROJECT_NUMBER»` from `.projectNumber` field
.. {rbbc_require} valid numeric project number

. *Enable Depot Project APIs*:
.. For each service in [`artifactregistry`, `cloudbuild`, `containeranalysis`, `storage`, `iam`, `serviceusage`]:
... Execute {rbtoe_api_enable} with service name and `«DEPOT_PROJECT_ID»`
.. {rbbc_require} all APIs enabled successfully

. *Grant {rbtr_payor} Permissions on Depot*:
.. {rbbc_call} link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/setIamPolicy[projects.setIamPolicy] for `«DEPOT_PROJECT_ID»`
.. Add {rbtr_payor} service account with roles:
... `roles/viewer`
... `roles/cloudbuild.builds.editor`
... `roles/serviceusage.serviceUsageConsumer`
.. Policy version: 3

. *Create Build Bucket*:
.. Construct bucket name: `rbw-«INPUT_DEPOT_NAME»-bucket`
.. {rbbc_call} link:https://cloud.google.com/storage/docs/json_api/v1/buckets/insert[storage.buckets.insert] with:
... name: `rbw-«INPUT_DEPOT_NAME»-bucket`
... location: `«INPUT_REGION»`
... project: `«DEPOT_PROJECT_ID»`
... lifecycle rule: delete objects after 1 day
.. {rbbc_store} `«BUILD_BUCKET»` as created bucket name

. *Create Container Repository*:
.. Construct repository name: `rbw-«INPUT_DEPOT_NAME»-repository`
.. {rbbc_submit} link:https://cloud.google.com/artifact-registry/docs/reference/rest/v1/projects.locations.repositories/create[artifactregistry.repositories.create] with:
... repositoryId: `rbw-«INPUT_DEPOT_NAME»-repository`
... format: `DOCKER`
... location: `«INPUT_REGION»`
... parent: `projects/«DEPOT_PROJECT_ID»/locations/«INPUT_REGION»`
.. {rbbc_await} returned operation
.. {rbbc_store} `«GAR_REPOSITORY»` as created repository name

. *Create
{rbtr_mason}
Service Account*:
.. NOTE: The
{rbtr_mason}
replaces Cloud Build's implicit service account to provide deterministic permissions and predictable authorization within the depot infrastructure.
.. {rbbc_call} link:https://cloud.google.com/iam/docs/reference/rest/v1/projects.serviceAccounts/create[iam.serviceAccounts.create] with:
... accountId: `rbw-«INPUT_DEPOT_NAME»-mason`
... displayName: `Mason for RB Depot: «INPUT_DEPOT_NAME»`
... project: `«DEPOT_PROJECT_ID»`
.. {rbbc_store} `«MASON_SERVICE_ACCOUNT»` from response `.email` field

. *Configure
{rbtr_mason}
Permissions*:
.. {rbbc_call} link:https://cloud.google.com/artifact-registry/docs/reference/rest/v1/projects.locations.repositories/setIamPolicy[repositories.setIamPolicy] for `«GAR_REPOSITORY»`
... Add `«MASON_SERVICE_ACCOUNT»` with `roles/artifactregistry.admin`
.. {rbbc_call} link:https://cloud.google.com/storage/docs/json_api/v1/buckets/setIamPolicy[buckets.setIamPolicy] for `«BUILD_BUCKET»`
... Add `«MASON_SERVICE_ACCOUNT»` with `roles/storage.objectViewer`
.. {rbbc_call} link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/setIamPolicy[projects.setIamPolicy] for `«DEPOT_PROJECT_ID»`
... Add `«MASON_SERVICE_ACCOUNT»` with `roles/viewer`

. *Enable Cloud Build service agent to impersonate
{rbtr_mason}*:
.. {rbbc_call} link:https://cloud.google.com/iam/docs/reference/rest/v1/projects.serviceAccounts/setIamPolicy[serviceAccounts.setIamPolicy] for `«MASON_SERVICE_ACCOUNT»`
.. Add member: `service-«PROJECT_NUMBER»@gcp-sa-cloudbuild.iam.gserviceaccount.com`
.. Grant role: `roles/iam.serviceAccountTokenCreator`
.. {rbbc_require} IAM binding successful (enables Cloud Build to execute as Mason)

. *Display Depot Configuration*:
.. {rbbc_show} depot creation successful
.. {rbbc_show} required RBRR configuration values:
... `RBRR_DEPOT_PROJECT_ID=«DEPOT_PROJECT_ID»`
... `RBRR_GCP_REGION=«INPUT_REGION»`
... `RBRR_GAR_REPOSITORY=«GAR_REPOSITORY»`
.. {rbbc_show} Mason service account: `«MASON_SERVICE_ACCOUNT»`
.. {rbbc_show} depot ready for
{rbtr_governor}
creation

. *Update Depot Tracking*:
.. Execute {rbtoe_depot_list_update} to add new depot to RBRP_DEPOT_PROJECT_IDS

[[rbtgo_depot_destroy]]
// ⟦axl_voices axo_command axe_bash_interactive⟧
=== {rbtgo_depot_destroy}

The
{rbtr_payor}
destroys an
{rbtgi_depot}
and all contained resources:

. *Safety Confirmation*:
.. {rbbc_require} `DEBUG_ONLY=1` environment variable for execution
.. Display comprehensive destruction warnings
.. {rbbc_require} operator confirmation with exact depot project ID

. *Authenticate as
{rbtr_payor}*:
.. Execute
{rbtoe_payor_authenticate}
.. {rbbc_require} authentication successful

. *Validate Target Depot*:
.. {rbbc_require} depot project ID provided as first argument
.. {rbbc_store} `«DEPOT_PROJECT_ID»` from argument
.. {rbbc_call} link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/get[projects.get] for `«DEPOT_PROJECT_ID»`
.. {rbbc_require} project exists and state is `ACTIVE`
.. {rbbc_fatal} if state is already `DELETE_REQUESTED`: "Project already marked for deletion"

. *Check for and remove
{gcp_lien_s}*:
.. {rbbc_call} link:https://cloud.google.com/resource-manager/reference/rest/v1/liens/list[liens.list] to list existing liens on resource: `projects/«DEPOT_PROJECT_ID»`
.. {rbbc_store} `«LIEN_LIST»` from response `.liens[]`
.. For each lien in `«LIEN_LIST»`:
... {rbbc_call} link:https://cloud.google.com/resource-manager/reference/rest/v1/liens/delete[liens.delete] to delete lien using `.name` field
... {rbbc_require} HTTP 200 response for each lien deletion
.. {rbbc_require} all liens removed before proceeding

. *Initiate depot deletion*:
.. {rbbc_submit} link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/delete[projects.delete] to execute project deletion for `projects/«DEPOT_PROJECT_ID»`
.. {rbbc_store} `«DELETE_OPERATION»` from response if Long Running Operation returned
.. {rbbc_await} `«DELETE_OPERATION»` if applicable
.. {rbbc_require} deletion initiated successfully

. *Verify deletion transition*:
.. {rbbc_call} link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/get[projects.get] to query project state for `projects/«DEPOT_PROJECT_ID»`
.. {rbbc_poll} project state with 5-10 second intervals for up to 60 seconds
.. {rbbc_require} project state equals `DELETE_REQUESTED`
.. {rbbc_store} `«DELETION_TIME»` from response `.deleteTime` field

. *Optional: Immediate billing stop*:
.. If immediate spend stop required, {rbbc_call} link:https://cloud.google.com/billing/docs/reference/rest/v1/projects/updateBillingInfo[cloudbilling.projects.updateBillingInfo] to update billing info for `projects/«DEPOT_PROJECT_ID»`
.. Set `billingAccountName` to empty string
.. {rbbc_require} billing unlink successful (HTTP 200)
.. Note: Standard deletion automatically stops billing, this step provides immediate termination

NOTE: Depot deletion automatically removes all infrastructure created by
{rbtgo_depot_create}:
the
{rbtr_mason}
service account,
{rbtgi_build_bucket},
{rbtgi_repository},
and any
{rbtr_governor},
{rbtr_director},
or
{rbtr_retriever}
service accounts created within the depot. No individual resource deletion required due to GCP's cascading deletion behavior.

NOTE: Project enters 30-day retention period in
{gcp_delete_requested}
state. Use
{rbbc_call}
link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/undelete[projects.undelete] to recover project if needed within retention window.

[[rbtgo_depot_list]]
// ⟦axl_voices axo_command axe_bash_interactive⟧
=== {rbtgo_depot_list}

The
{rbtr_payor}
lists all
{rbtgi_depot}
instances and their status:

. *Authenticate as
{rbtr_payor}*:
.. Execute
{rbtoe_payor_authenticate}

. *Query depot projects*:
.. {rbbc_call} link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/list[projects.list] with filter: `projectId:rbw-* AND lifecycleState:ACTIVE`
.. {rbbc_store} `«DEPOT_PROJECTS»` from response

. *Validate each depot*:
.. For each project in `«DEPOT_PROJECTS»`:
... Extract depot name from project ID pattern `rbw-«NAME»-«TIMESTAMP»`
... Check for Mason service account: `rbw-«NAME»-mason`
... Check for repository: `rbw-«NAME»-repository`
... Check for bucket: `rbw-«NAME»-bucket`
... Display status: COMPLETE, BROKEN (missing resources), or DELETE_REQUESTED

. *Display summary*:
.. {rbbc_show} total depot count
.. {rbbc_show} each depot with ID, name, region, and status

[[rbtgo_governor_create]]
// ⟦axl_voices axo_command axe_bash_interactive⟧
=== {rbtgo_governor_create}

The
{rbtr_payor}
creates a
{rbtr_governor}
{giam_service_account}
within the
{rbtgi_depot_project}:

. *Step 1: Depot Project Validation*:
.. {rbbc_require} {rbrr_depot_project_id} exists (via projects.get API call)
.. {rbbc_require} {rbrr_depot_project_id} != {rbrp_payor_project_id}

. Create the
{rbtr_governor}
{giam_service_account}:
.. {rbbc_call}
link:https://cloud.google.com/iam/docs/reference/rest/v1/projects.serviceAccounts/create[iam.serviceAccounts.create]
to create service account in
{rbrr_depot_project_id}
.. Set `accountId` to `«INPUT_ACCOUNT_ID»` following RB naming conventions
.. Use display name: `
{rbtr_governor}
role for project administration`
.. {rbbc_store} `«GOVERNOR_SERVICE_ACCOUNT»` from response `.email` field
.. {rbbc_require} service account creation successful (HTTP 200)
. Verify
{giam_service_account}
creation and propagation:
.. {rbbc_call}
link:https://cloud.google.com/iam/docs/reference/rest/v1/projects.serviceAccounts/get[iam.serviceAccounts.get]
to query service account using
`«GOVERNOR_SERVICE_ACCOUNT»`
.. {rbbc_poll} with 3-5 second intervals for up to 30 seconds if service account not immediately available
.. {rbbc_require} service account accessible before proceeding
. Preflight: Ensure pristine key state:
.. {rbbc_call}
link:https://cloud.google.com/iam/docs/reference/rest/v1/projects.serviceAccounts.keys/list[serviceAccounts.keys.list]
to list existing keys for
`«GOVERNOR_SERVICE_ACCOUNT»`
.. {rbbc_store} `«EXISTING_KEYS»` from response `.keys[]`
.. {rbbc_require} no keys with `keyType: USER_MANAGED` exist (pristine-state requirement)
.. {rbbc_fatal} if conflicts found - manual cleanup required
. Grant
{gcp_project_id}
-level
permissions:
.. {rbbc_call}
link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/setIamPolicy[projects.setIamPolicy]
to update IAM policy on
{rbrr_depot_project_id}
.. {rbbc_use} `«GOVERNOR_SERVICE_ACCOUNT»` as principal
.. Add role: `roles/owner` (excluding billing permissions maintained by
{rbtr_payor})
.. Set policy version: 3 for conditional binding support
.. {rbbc_require} IAM policy update successful
. Generate
{rbrr_governor_rbra_file}:
.. {rbbc_call}
link:https://cloud.google.com/iam/docs/reference/rest/v1/projects.serviceAccounts.keys/create[serviceAccounts.keys.create]
to create service account key for
`«GOVERNOR_SERVICE_ACCOUNT»`
.. Set keyAlgorithm: `KEY_ALG_RSA_2048`, privateKeyType: `TYPE_GOOGLE_CREDENTIALS_FILE`
.. {rbbc_store} `«GOVERNOR_PRIVATE_KEY_DATA»` from response `.privateKeyData` field
.. {rbtoe_rbra_generate} converts
`«GOVERNOR_PRIVATE_KEY_DATA»`
to
`{rbrr_governor_rbra_file}`
.. NOTE: Script outputs copy command for RBRA file installation
.. {rbbc_warn} if {rbrr_governor_rbra_file} already exists
.. {rbbc_require} RBRA file creation successful

== {rbtr_governor} Operations

[[rbtgo_retriever_create]]
// ⟦axl_voices axo_command axe_bash_interactive⟧
=== {rbtgo_retriever_create}

The
{rbtr_governor}
creates a
{rbtr_retriever}
{giam_service_account}
with read-only
{rbtgi_repository}
access and generates credentials using
{rbtoe_rbra_generate}
to create
{rbrr_retriever_rbra_file}.

NOTE: Script outputs copy command for RBRA file installation.
{rbbc_warn}
if
{rbrr_retriever_rbra_file}
already exists.

[[rbtgo_director_create]]
// ⟦axl_voices axo_command axe_bash_interactive⟧
=== {rbtgo_director_create}

The
{rbtr_governor}
creates a
{rbtr_director}
{giam_service_account}
with build management permissions and generates credentials using
{rbtoe_rbra_generate}
to create
{rbrr_director_rbra_file}.

NOTE: Script outputs copy command for RBRA file installation.
{rbbc_warn}
if
{rbrr_director_rbra_file}
already exists.

== {rbtr_director} Operations

[[rbtgo_trigger_build]]
// ⟦axl_voices axo_command axe_bash_interactive⟧
=== {rbtgo_trigger_build}

[[rbtgo_image_delete]]
// ⟦axl_voices axo_command axe_bash_interactive⟧
=== {rbtgo_image_delete}

== {rbtr_retriever} Operations

[[rbtgo_image_retrieve]]
// ⟦axl_voices axo_command axe_bash_interactive⟧
=== {rbtgo_image_retrieve}

== Multi Role Operations

[[rbtgo_sa_list]]
// ⟦axl_voices axo_command axe_bash_interactive⟧
=== {rbtgo_sa_list}

[[rbtgo_sa_delete]]
// ⟦axl_voices axo_command axe_bash_interactive⟧
=== {rbtgo_sa_delete}

== Definitions

=== Core {gcp_project_id} Terms

[[at_recipe_bottle]]
{at_recipe_bottle}::
The comprehensive container management platform that enables secure, role-based building, deployment, and retrieval of containerized applications through
{gcp_service}
infrastructure.

=== RB Role Infrastructure

[[rbtr_role]]
// ⟦axl_voices axo_identity⟧
{rbtr_role}::
An operational identity within the
{at_recipe_bottle}
system
that a
{at_user}
can assume to perform specific cloud operations.
Each
{rbtr_role}
is implemented through a dedicated
{giam_service_account}
and corresponding
{rbtgi_rbra_file}
containing the necessary credentials, with the exception of the
{rbtr_mason}
which operates exclusively within cloud infrastructure.

=== {giam_service_account} Definitions

[[rbtr_payor]]
// ⟦axl_voices axo_actor⟧
{rbtr_payor}::
An
{rbtr_role}
that enables a
{at_user}
to manage billing accounts and create depot projects using OAuth user authentication rather than service accounts.
The
{rbtr_payor}
operates through OAuth 2.0 desktop application flow, enabling individual developers to manage Recipe Bottle infrastructure without requiring organization-level permissions.

[[rbtr_governor]]
// ⟦axl_voices axo_actor⟧
{rbtr_governor}::
An
{rbtr_role}
that grants a
{at_user}
{gcp_project_id}
-scope Owner permissions without billing authority, designed for automation-friendly operations.

[[rbtr_retriever]]
// ⟦axl_voices axo_actor⟧
{rbtr_retriever}::
An
{rbtr_role}
that allows a
{at_user}
read-only access to the
{rbtgi_repository}
for pulling
{rbtgi_image_s}.

[[rbtr_mason]]
// ⟦axl_voices axo_actor⟧
{rbtr_mason}::
A cloud-native
{giam_service_account}
that operates exclusively within the
{rbtgi_depot_project}
to execute
{at_recipe_bottle}
build instructions from the
{rbtr_director}.

The
{rbtr_mason}
impersonates the implicit service agent for builds, replacing Google's auto-created service agent with deterministic permissions and predictable authorization.

The
{rbtr_mason}
reads from the
{rbtgi_build_bucket},
carries out the build process within
{gcb_service},
and publishes
{rbtgi_image_s}
and
{rbtgi_metadata_s}
to the
{rbtgi_repository}
without requiring a local
{rbtgi_rbra_file}
since it operates entirely within the cloud infrastructure.

[[rbtr_director]]
// ⟦axl_voices axo_actor⟧
{rbtr_director}::
An
{rbtr_role}
that grants a
{at_user}
full build lifecycle permissions including Cloud Build submission and
{rbtgi_repository}
management.

=== {gcp_service} Definitions

[[rbtgi_depot_project]]
{rbtgi_depot_project}::
The dedicated
{gcp_service}
project instance containing all Recipe Bottle depot resources, APIs, and
{giam_service_account_s}
for container building and management. Created and managed by the
{rbtr_payor}
role.

[[rbtgi_depot]]
{rbtgi_depot}::
A cohesive unit of Recipe Bottle infrastructure comprising a
{rbtgi_depot_project},
{rbtgi_build_bucket},
{rbtgi_repository},
and
{rbtr_mason}
service account that share their productive lifecycle. Created as a unit by
{rbtgo_depot_create}
and destroyed as a unit by
{rbtgo_depot_destroy}.

[[rbtgi_payor_project]]
{rbtgi_payor_project}::
The administrative
{gcp_service}
project that hosts the
{rbtr_payor}
{giam_service_account}.
This
{gcp_project_id}
serves as the control plane for creating and managing multiple
{rbtgi_depot_project}
instances.


[[rbtgi_build_bucket]]
{rbtgi_build_bucket}::
The dedicated
{gcs_bucket}
within the
{rbtgi_depot_project}
that holds
{at_recipe_bottle}
build artifacts with configured lifecycle policies.

=== {gar_service} Definitions

[[rbtgi_repository]]
{rbtgi_repository}::
The managed
{gar_service}
repository within the
{rbtgi_depot_project}
that stores
{at_recipe_bottle}
{rbtgi_image_s}
and metadata.

[[rbtgi_image]]
{rbtgi_image}::
A
{at_recipe_bottle}
container image stored in the
{rbtgi_repository}
with associated tags and digest.

[[rbtgi_metadata]]
{rbtgi_metadata}::
A compressed archive containing
{at_recipe_bottle}
build transcript, SBOM, and provenance data stored in the
{rbtgi_repository}
as a Generic Artifact.

=== Support Infrastructure Definitions

[[giam_binding]]
{giam_binding}::
An association between a
{giam_service_account}
and a specific permission role within a resource scope.

[[oauth_token]]
{oauth_token}::
A time-limited credential exchanged from
{giam_service_account}
keys for API authentication.


[[rbtgi_rbra_file]]
{rbtgi_rbra_file}::
A bash-sourceable environment file containing Google
{giam_service_account}
credentials in RBRA (Recipe Bottle Role Authentication) format.
Created by
{rbtoe_rbra_generate}
from
{rbtgi_json_key_file}
with field mappings: `RBRA_CLIENT_EMAIL` from `.client_email`, `RBRA_PRIVATE_KEY` from `.private_key`, `RBRA_PROJECT_ID` from `.project_id`.
Loaded via
{rbtoe_rbra_load}
with validation of all required fields.

[[rbtgi_json_key_file]]
{rbtgi_json_key_file}::
A Google
{giam_service_account}
JSON key file in its native format as downloaded from the Google Cloud Console, containing the complete credential structure including private_key, client_email, project_id, and other metadata required for authentication.

=== {gcp_service} Core Definitions

[[gcp_organization]]
{gcp_organization}::
The top-level administrative entity in
{gcp_service}
that contains projects and folders.

[[gcp_folder]]
{gcp_folder}::
An organizational unit within a
{gcp_organization}
that groups
{gcp_project_id_s}
for management purposes.

[[gcp_project_number]]
{gcp_project_number}::
A globally unique numeric identifier automatically assigned to every
{gcp_service}
{gcp_project_id}.

[[gcp_project_id]]
{gcp_project_id}::
A globally unique string identifier chosen during
{gcp_project_id}
creation that serves as the
{gcp_project_id}
's primary reference.

[[gcp_lro]]
{gcp_lro}::
A Long Running Operation, an asynchronous operation in
{gcp_service}
that returns immediately but continues processing in the background.

[[gcp_delete_requested]]
{gcp_delete_requested}::
A
{gcp_project_id}
lifecycle state indicating deletion has been initiated but the
{gcp_project_id}
remains recoverable for 30 days.

[[gcp_billing_enabled]]
{gcp_billing_enabled}::
A
{gcp_project_id}
status indicating that billing is active and the
{gcp_project_id}
can incur charges.

=== Google Service Definitions

[[gar_registry]]
{gar_registry}::
Google's managed service for storing and managing container images and other software artifacts.

[[gcs_bucket]]
{gcs_bucket}::
A container for storing objects in
{gcs_service}
with configurable access controls and lifecycle policies.

[[gcb_build]]
{gcb_build}::
An execution instance of
{gcb_service}
that processes build instructions to create artifacts.

[[giam_role]]
{giam_role}::
A collection of permissions that can be granted to users,
{giam_service_account_s},
or groups in
{gcp_service}.

[[gcp_lien]]
{gcp_lien}::
A restriction placed on a
{gcp_service}
resource to prevent accidental deletion or modification.

[[giam_service_account]]
{giam_service_account}::
A
{gcp_service}
identity that applications and services use to authenticate and authorize API operations, consisting of an email address, unique ID, and associated cryptographic keys for non-interactive authentication.

=== Bash Console Control Voicings

Control terms for Recipe Bottle operations executing in a bash shell with human operator present.
Each term voices the corresponding {xref_AXLA} control motif in the {axe_bash_interactive} environment.

[[rbbc_variable]]
// ⟦axl_voices axc_variable axe_bash_interactive⟧
{rbbc_variable}::
A shell variable denoted by guillemets `«NAME»` storing intermediate results.
Implemented as bash variables or associative array entries.

[[rbbc_fatal]]
// ⟦axl_voices axc_fatal axe_bash_interactive⟧
{rbbc_fatal}::
Red console text followed by `exit 1`.
Script terminates immediately. Human operator must intervene.

[[rbbc_warn]]
// ⟦axl_voices axc_warn axe_bash_interactive⟧
{rbbc_warn}::
Yellow console text indicating non-blocking concern.
Script continues execution. Human operator may note for later.

[[rbbc_store]]
// ⟦axl_voices axc_store axe_bash_interactive⟧
{rbbc_store}::
Capture of a value from command output or API response into a {rbbc_variable}.
Typically via bash assignment or jq extraction.

[[rbbc_use]]
// ⟦axl_voices axc_use axe_bash_interactive⟧
{rbbc_use}::
Reference to a previously stored {rbbc_variable} value.
Expanded via bash variable substitution.

[[rbbc_require]]
// ⟦axl_voices axc_require axe_bash_interactive⟧
{rbbc_require}::
Validation check that confirms an expected condition.
Triggers {rbbc_fatal} if condition not met.

[[rbbc_poll]]
// ⟦axl_voices axc_poll axe_bash_interactive⟧
{rbbc_poll}::
Repeated execution of a command at defined intervals until condition satisfied or timeout.
Implemented as bash while loop with sleep.

[[rbbc_call]]
// ⟦axl_voices axc_call axe_bash_interactive⟧
{rbbc_call}::
Synchronous invocation of a REST API endpoint via curl.
Captures HTTP status code and response body. Returns when response received.

[[rbbc_submit]]
// ⟦axl_voices axc_submit axe_bash_interactive⟧
{rbbc_submit}::
Asynchronous invocation of a REST API that returns an LRO operation handle.
Returns immediately with operation ID for later {rbbc_await}.

[[rbbc_await]]
// ⟦axl_voices axc_await axe_bash_interactive⟧
{rbbc_await}::
Blocking wait on a submitted LRO operation until completion.
Polls operation endpoint until done=true, then returns result.

[[rbbc_show]]
// ⟦axl_voices axc_show axe_bash_interactive⟧
{rbbc_show}::
Presentation of operational facts to the console.
Formatted output via echo or printf to stdout.

=== Human Guide Control Voicings

Control terms for Recipe Bottle procedures executed by a human operator following a rendered document while interacting with external systems (web console, GUI).
Each term voices the corresponding {xref_AXLA} control motif in the {axe_human_guide} environment.

[[rbhg_fatal]]
// ⟦axl_voices axc_fatal axe_human_guide⟧
{rbhg_fatal}::
Instruction to abort the procedure immediately.
Human must not proceed. May require rollback or support contact.

[[rbhg_warn]]
// ⟦axl_voices axc_warn axe_human_guide⟧
{rbhg_warn}::
Cautionary note requiring human acknowledgment before proceeding.
Highlights potential issues or irreversible actions.

[[rbhg_store]]
// ⟦axl_voices axc_store axe_human_guide⟧
{rbhg_store}::
Instruction for human to record a value for later use.
Typically written down, copied to clipboard, or saved to a file.

[[rbhg_require]]
// ⟦axl_voices axc_require axe_human_guide⟧
{rbhg_require}::
Verification checkpoint where human confirms a condition before proceeding.
May involve visual inspection or testing in external UI.

[[rbhg_show]]
// ⟦axl_voices axc_show axe_human_guide⟧
{rbhg_show}::
Informational note presented to the human during procedure.
Provides context or expected outcomes without requiring action.

=== Recipe Bottle Orchestration Patterns (RB-specific)

[[rbtoe_rbra_generate]]
// ⟦axl_voices axo_pattern axe_bash_interactive⟧
{rbtoe_rbra_generate}::
A pattern that converts Google
{giam_service_account}
credentials into
{rbtgi_rbra_file}
format:
extracts `client_email`, `private_key`, and `project_id` from base64-encoded key data or JSON structure,
converts to RBRA environment variables (`RBRA_CLIENT_EMAIL`, `RBRA_PRIVATE_KEY`, `RBRA_PROJECT_ID`),
and writes to specified file path with 600 permissions (owner read/write only).

[[rbtoe_rbra_load]]
// ⟦axl_voices axo_pattern axe_bash_interactive⟧
{rbtoe_rbra_load}::
A pattern that sources an
{rbtgi_rbra_file}
and validates required fields:
sources the specified RBRA file into the current environment,
validates that `RBRA_CLIENT_EMAIL`, `RBRA_PRIVATE_KEY`, and `RBRA_PROJECT_ID` are all present and non-empty,
and triggers
{rbbc_fatal}
with standardized error message if any field is missing or invalid.

[[rbtoe_jwt_oauth_exchange]]
// ⟦axl_voices axo_pattern axe_bash_interactive⟧
{rbtoe_jwt_oauth_exchange}::
A pattern that exchanges
{giam_service_account}
RBRA credentials for an
{oauth_token}:
constructs JWT with RS256 signature using RBRA_PRIVATE_KEY,
sets JWT claims (iss=RBRA_CLIENT_EMAIL, aud=https://oauth2.googleapis.com/token, scope=https://www.googleapis.com/auth/cloud-platform),
POSTs to OAuth2 token endpoint,
returns access_token from response,
triggers
{rbbc_fatal}
on non-200 HTTP response.

[[rbtoe_api_enable]]
// ⟦axl_voices axo_pattern axe_bash_interactive⟧
{rbtoe_api_enable}::
A pattern that ensures a specified Google Cloud API is enabled in a project with idempotent behavior:

. attempts to enable the API via serviceusage.services.enable,
. tolerates HTTP 200 (success) or HTTP 400 with "already enabled" error,
. executes
{rbbc_await}
if Long Running Operation returned,
. verifies API state is ENABLED via serviceusage.services.get,
. triggers
{rbbc_fatal}
on unexpected errors (409 conflicts, permission denied, etc.),
. returns success when API is confirmed enabled.


[[rbtoe_oauth_refresh]]
// ⟦axl_voices axo_pattern axe_bash_interactive⟧
{rbtoe_oauth_refresh}::
A pattern that exchanges OAuth refresh token for access token:

. loads RBRO_REFRESH_TOKEN and RBRO_CLIENT_SECRET from
{rbro_regime},
. loads RBRP_OAUTH_CLIENT_ID from
{rbrp_payor_project_id}
configuration,
. constructs JSON request with refresh_token, client_id, client_secret, and grant_type=refresh_token,
. POSTs to https://oauth2.googleapis.com/token with Content-Type: application/json,
. validates HTTP 200 response or triggers
{rbbc_fatal}
with error description,
. extracts access_token from JSON response,
. {rbbc_require} access_token is present and non-empty,
. returns fresh access_token for immediate use,
. handles 400/401 errors by triggering
{rbbc_fatal}
with "OAuth credentials expired or invalid - run
{rbtgo_payor_refresh}
".

[[rbtoe_payor_authenticate]]
// ⟦axl_voices axo_pattern axe_bash_interactive⟧
{rbtoe_payor_authenticate}::
A pattern that establishes
{rbtr_payor}
OAuth context:

. executes
{rbtoe_rbro_load}
to load OAuth credentials,
. loads RBRP_OAUTH_CLIENT_ID from rbrp.env configuration,
. executes
{rbtoe_oauth_refresh}
to obtain access token,
. stores token as `«PAYOR_ACCESS_TOKEN»` for subsequent API calls.

[[rbtoe_rbro_load]]
// ⟦axl_voices axo_pattern axe_bash_interactive⟧
{rbtoe_rbro_load}::
A pattern that loads and validates RBRO credentials:

. {rbbc_require} ~/.rbw/ directory exists or
{rbbc_fatal}
"RBRO directory missing - run {rbtgo_payor_install}",
. {rbbc_require} ~/.rbw/rbro.env file exists or
{rbbc_fatal}
"RBRO credentials missing - run {rbtgo_payor_install}",
. validates file permissions are 600 or
{rbbc_warn}
"RBRO file permissions should be 600",
. sources ~/.rbw/rbro.env into current environment,
. validates RBRO_CLIENT_SECRET is present and non-empty or
{rbbc_fatal}
"RBRO_CLIENT_SECRET missing",
. validates RBRO_REFRESH_TOKEN is present and non-empty or
{rbbc_fatal}
"RBRO_REFRESH_TOKEN missing",
. returns success when all RBRO variables are loaded and validated.

[[rbtoe_depot_list_update]]
// ⟦axl_voices axo_pattern axe_bash_interactive⟧
{rbtoe_depot_list_update}::
A pattern that synchronizes depot project tracking:

. executes
{rbtoe_payor_authenticate}
to obtain access token,
. {rbbc_call} link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/list[projects.list] with filter `projectId:rbw-depot-* AND lifecycleState:ACTIVE`,
. {rbbc_require} HTTP 200 response from projects API,
. extracts project IDs from `.projects[].projectId` array,
. validates each project ID matches pattern `rbw-[name]-[timestamp]`,
. constructs space-delimited string from valid depot project IDs,
. updates RBRP_DEPOT_PROJECT_IDS in rbrp.env file,
. handles empty results by setting RBRP_DEPOT_PROJECT_IDS="",
. {rbbc_require} rbrp.env file update successful,
. invoked by
{rbtgo_payor_install},
{rbtgo_depot_create},
and
{rbtgo_depot_destroy}
operations.

=== Cross-Reference Definitions

[[at_rbm_system]]
{at_rbm_system}::
The complete
{at_recipe_bottle}
system enabling secure container management.

[[at_bottle_image]]
{at_bottle_image}::
A container image built or replicated through the Google build infrastructure.

[[at_user]]
{at_user}::
An individual operating the
{at_rbm_system}
to build and manage containers.

[[at_workstation]]
{at_workstation}::
The local environment where
{at_user_s}
execute
{at_rbm_system}
commands.

[[at_base_utilities]]
{at_base_utilities}::
The minimal set of command-line tools
(`bash`, `git`, `curl`, `openssh`, `jq`)
required on the
{at_workstation}.

== Configuration Regime Definitions

[[at_regime]]
{at_regime}::
A controlled set of environment variables with a consistent prefix that establishes configuration boundaries for specific operational scopes within the
{at_recipe_bottle}
system.

[[rbrr_prefix]]
// ⟦axl_voices axrg_prefix⟧
{rbrr_prefix}::
Recipe Bottle Repository Regime

[[rbrp_prefix]]
// ⟦axl_voices axrg_prefix⟧
{rbrp_prefix}::
Recipe Bottle Payor Regime

[[rbro_prefix]]
// ⟦axl_voices axrg_prefix⟧
{rbro_prefix}::
Recipe Bottle OAuth Regime

[[rbrv_prefix]]
// ⟦axl_voices axrg_prefix⟧
{rbrv_prefix}::
Recipe Bottle Vessel Regime

[[rbra_prefix]]
// ⟦axl_voices axrg_prefix⟧
{rbra_prefix}::
Recipe Bottle Authentication Regime

[[rbev_prefix]]
// ⟦axl_voices axrg_prefix⟧
{rbev_prefix}::
Recipe Bottle Environment Variables Regime

=== Repository Regime (RBRR)

The
{at_regime}
defines installation-wide configuration that rarely changes and is shared across all
{at_recipe_bottle}
operations.
This specification documents only the subset of RBRR variables relevant to
{gcp_service}
operations.

[[rbrr_regime]]
// ⟦axl_voices axrg_regime axf_bash⟧
{rbrr_regime}::
An
{at_regime}
that defines repository-wide configuration and installation-wide settings shared across all
{at_recipe_bottle}
operations.
RBRR regimes contain depot project identifiers, regional settings, repository locations, and service account credential file paths that establish the foundational infrastructure configuration.

[[rbrr_depot_project_id]]
{rbrr_depot_project_id}::
The
{gcp_service}
{gcp_project_id}
where all
{at_recipe_bottle}
resources are created and managed.
Used as the target
{gcp_project_id}
in API calls and as the audience claim in
{oauth_token}
exchange.

[[rbrr_gcp_region]]
{rbrr_gcp_region}::
The default
{gcp_service}
region for regional services like
{gar_service}
and
{gcb_service}.
Applied when creating repositories and submitting builds unless overridden by operation-specific configuration.

[[rbrr_gar_repository]]
{rbrr_gar_repository}::
The
{gar_service}
{rbtgi_repository}
name within
{rbrr_depot_project_id}
that stores all
{at_bottle_image_s}
and
{rbtgi_metadata_s}.

[[rbrr_retriever_rbra_file]]
{rbrr_retriever_rbra_file}::
Path to an
{rbtgi_rbra_file}
stored in the
{at_user_p}
local filesystem outside the source
{rbtgi_repository}.
This file enables the
{at_user}
to assume the
{rbtr_retriever}
role for container image operations.

[[rbrr_director_rbra_file]]
{rbrr_director_rbra_file}::
Path to an
{rbtgi_rbra_file}
stored in the
{at_user_p}
local filesystem outside the source
{rbtgi_repository}.
This file enables the
{at_user}
to assume the
{rbtr_director}
for build submission and image management operations.

[[rbrr_governor_rbra_file]]
{rbrr_governor_rbra_file}::
Path to an
{rbtgi_rbra_file}
stored in the
{at_user_p}
local filesystem outside the source
{rbtgi_repository}.
This file enables the
{at_user}
to assume the
{rbtr_governor}
role for
{gcp_project_id}
administration operations.

[[rbrr_payor_rbra_file]]
{rbrr_payor_rbra_file}::
Path to an
{rbtgi_rbra_file}
stored in the
{at_user_p}
local filesystem outside the source
{rbtgi_repository}.
This file enables the
{at_user}
to assume the
{rbtr_payor}
role for billing and
{gcp_project_id}
lifecycle operations.

=== Account Regime (RBRA)

An {rbtgi_rbra_file} is a credentials file containing the minimum identity and signing material needed for
{at_recipe_bottle}
tools to authenticate to
{gcp_service}
via
{giam_service_account}.

[[rbra_client_email]]
{rbra_client_email}::
The
{giam_service_account}
email address assigned by
{gcp_service},
used as the issuer (`iss`) when constructing JWTs for OAuth2 token exchange.

[[rbra_private_key]]
{rbra_private_key}::
The PEM-encoded RSA private key material corresponding to the
{giam_service_account}.
Stored as a literal multi-line string with `\n` sequences that are expanded when signing JWTs.
Used only in memory at runtime; never written separately to disk.

[[rbra_project_id]]
{rbra_project_id}::
The
{gcp_service}
{gcp_project_id}
that owns the
{giam_service_account}.
Provides scope for all API operations since a
{giam_service_account}
can only act within its parent project's boundaries unless granted cross-project roles.

=== Payor Regime (RBRP)

The
{rbtr_payor}
{at_regime}
defines configuration for the administrative layer that manages
{at_recipe_bottle}
infrastructure.
These settings control how the
{rbtr_payor}
creates and manages
{rbtgi_depot_project}
instances.

[[rbrp_regime]]
// ⟦axl_voices axrg_regime axf_bash⟧
{rbrp_regime}::
An
{at_regime}
that contains configuration for the administrative
{rbtr_payor}
layer managing
{at_recipe_bottle}
infrastructure.
RBRP regimes define payor project identification, billing account linkage, OAuth client configuration, and depot project tracking arrays that enable infrastructure lifecycle management.

[[rbrp_payor_project_id]]
{rbrp_payor_project_id}::
The
{gcp_service}
{gcp_project_id}
that hosts the OAuth 2.0 client configuration for
{rbtr_payor}
operations.
This
{gcp_project_id}
must exist before Recipe Bottle initialization and serves as the administrative control plane.

[[rbrp_billing_account_id]]
{rbrp_billing_account_id}::
The
{gcp_service}
billing account identifier that the
{rbtr_payor}
links to newly created
{rbtgi_depot_project}
instances.
Format: XXXXXX-XXXXXX-XXXXXX.

[[rbrp_oauth_client_id]]
{rbrp_oauth_client_id}::
The public OAuth 2.0 client identifier for the
{rbtr_payor}
desktop application.

[[rbrp_depot_project_ids]]
{rbrp_depot_project_ids}::
Space-delimited array of active depot project IDs managed by this
{rbtr_payor}.

=== OAuth Regime (RBRO)

The OAuth
{at_regime}
stores sensitive OAuth credentials locally for
{rbtr_payor}
authentication.

[[rbro_regime]]
// ⟦axl_voices axrg_regime axf_bash⟧
{rbro_regime}::
An
{at_regime}
containing OAuth client credentials and refresh tokens for
{rbtr_payor}
operations.
Stored in `~/.rbw/rbro.env` with 600 permissions, never committed to version control.

[[rbro_client_secret]]
{rbro_client_secret}::
The OAuth 2.0 client secret from the Google Cloud Console OAuth client configuration.

[[rbro_refresh_token]]
{rbro_refresh_token}::
The long-lived OAuth refresh token obtained during the authorization flow, used to obtain fresh access tokens.

=== Vessel Regime (RBRV)

[[rbrv_regime]]
// ⟦axl_voices axrg_regime axf_bash⟧
{rbrv_regime}::
An
{at_regime}
that defines container image build specifications and vessel configurations within the
{at_recipe_bottle}
system.
RBRV regimes are found in `rbev-vessels/*/rbrv.env` files and control the build process for specific container image types.
Each vessel represents a distinct container image configuration with its own build parameters and runtime characteristics.

NOTE: Individual RBRV variables are actively used throughout the system but formal definition within RBAGS specification is TBD for future documentation efforts.

=== Authentication Regime (RBRA)

[[rbra_regime]]
// ⟦axl_voices axrg_regime axf_bash⟧
{rbra_regime}::
An
{at_regime}
that contains
{giam_service_account}
credentials and authentication material for secure access to
{gcp_service}
APIs.
RBRA regimes are security-isolated configuration files typically stored outside the main repository in `../station-files/secrets/rbra-*.env` locations.
These regimes enable different service account roles to authenticate and operate within their designated scopes.

NOTE: Individual RBRA variables beyond the core documented set are actively used throughout the system but formal definition within RBAGS specification is TBD for future documentation efforts.

=== Environment Variables Regime (RBEV)

[[rbev_regime]]
// ⟦axl_voices axrg_regime axf_bash⟧
{rbev_regime}::
An
{at_regime}
that defines runtime container environment variables and configuration parameters for active
{at_bottle_image}
instances.
RBEV regimes specify container execution parameters, port mappings, working directories, and other runtime characteristics that are applied when containers are instantiated.
These configurations are typically embedded within recipe files and container orchestration specifications.

NOTE: Individual RBEV variables are actively used throughout the system but formal definition within RBAGS specification is TBD for future documentation efforts.
