NOTE: This operation copies the chosen VM image from upstream to the user's GHCR, ensuring consistent deployment across environments. It validates preconditions, performs the copy, and verifies podman can access the mirrored image.

// ⟦axs_inputs⟧
. *Validate Preconditions*:
.. {rbbc_use}
{rbrr_chosen_vmimage_fqin} to determine source
.. If {rbrr_chosen_vmimage_fqin} starts with {rbrr_chosen_vmimage_origin}:
... {rbbc_call}
crane digest for {rbrr_chosen_vmimage_origin}:{rbrr_chosen_podman_version}
... {rbbc_store}
`«UPSTREAM_SHA»` from crane response
... If {rbrr_chosen_vmimage_sha} is defined:
.... Compare `«UPSTREAM_SHA»` with {rbrr_chosen_vmimage_sha}
.... {rbbc_fatal}
if SHAs do not match: "Upstream SHA mismatch - run {ops_rbv_check} first"

// ⟦axs_behavior⟧
. *Generate GHCR Target*:
.. {rbbc_use}
{rbrr_registry_owner}, {rbrr_registry_name}, {rbrr_chosen_podman_version}
.. Construct target: `ghcr.io/{rbrr_registry_owner}/{rbrr_registry_name}/vmimage:{rbrr_chosen_podman_version}`
.. {rbbc_store}
`«GHCR_TARGET»` as mirror destination

. *Check Existing Mirror*:
.. {rbbc_call}
crane digest for `«GHCR_TARGET»`
.. If image exists at GHCR:
... {rbbc_store}
`«EXISTING_SHA»` from crane response
... If {rbrr_chosen_vmimage_sha} is defined:
.... Compare `«EXISTING_SHA»` with {rbrr_chosen_vmimage_sha}
.... If match confirmed:
..... {rbbc_show}
"Mirror already exists with correct SHA"
..... Exit successfully
.... {rbbc_fatal}
if SHAs differ: "Existing mirror SHA mismatch"

. *Copy Image to GHCR*:
.. {rbbc_call}
crane copy from {rbrr_chosen_vmimage_fqin} to `«GHCR_TARGET»`
.. {rbbc_require}
copy completed without errors
.. {rbbc_require}
transferred image integrity confirmed

. *Verify Copied Image*:
.. If {rbrr_chosen_vmimage_sha} is defined:
... {rbbc_call}
crane digest for `«GHCR_TARGET»`
... {rbbc_store}
`«COPIED_SHA»` from crane response
... Compare `«COPIED_SHA»` with {rbrr_chosen_vmimage_sha}
... {rbbc_fatal}
if verification shows mismatch: "Copied image SHA does not match expected value"

. *Validate Podman Access*:
.. {rbbc_store}
`«TEST_MACHINE»` as validation machine identifier with timestamp
.. {rbbc_call}
podman machine init for `«TEST_MACHINE»` using `«GHCR_TARGET»` as image
.. Capture initialization output
.. Extract reported SHA from initialization output
.. {rbbc_store}
`«PODMAN_SHA»` from extracted value
.. If {rbrr_chosen_vmimage_sha} is defined:
... Compare `«PODMAN_SHA»` with {rbrr_chosen_vmimage_sha}
... {rbbc_fatal}
if SHAs differ: "Podman reported SHA mismatch"
.. {rbbc_call}
podman machine rm for `«TEST_MACHINE»`
.. {rbbc_require}
test machine removed successfully

// ⟦axs_outputs⟧
. *Report Success*:
.. {rbbc_show}
mirror operation completed
.. {rbbc_show}
image available at: `«GHCR_TARGET»`
.. {rbbc_show}
podman successfully validated mirrored image

// ⟦axs_completion⟧
Successful execution creates verified mirror of VM image in GHCR and confirms podman can access it.
