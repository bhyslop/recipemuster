= Recipe Bottle Service Configuration Regime Specification
:toc:
:toc-title: Table of Contents

// Begin Mapping Section
// tag::mapping-section[]

// Category declarations:
// at_ prefix: Architectural Term (core system components)
// st_ prefix: Support Term (infrastructure and technical concepts)

// Variant patterns:
//   _s: plural form
//   _p: possessive form
//   _ed: past tense (verbs)
//   _ing: progressive form (verbs)

// Domain declaration: term_<canonical_term>

:at_bottle_service:          <<term_bottle_service,Bottle Service>>
:at_bottle_container:        <<term_bottle_container,Bottle Container>>
:at_bottle_container_s:      <<term_bottle_container,Bottle Containers>>
:at_bottle_image:            <<term_bottle_image,Bottle Image>>
:at_sentry_container:        <<term_sentry_container,Sentry Container>>
:at_sentry_image:            <<term_sentry_image,Sentry Image>>
:at_nameplate:               <<term_nameplate,Nameplate>>
:at_nameplate_s:             <<term_nameplate,Nameplates>>
:at_moniker:                 <<term_moniker,Moniker>>
:at_workstation:             <<term_workstation,Workstation>>
:at_workstation_p:           <<term_workstation,Workstation's>>
:at_user:                    <<term_user,User>>
:at_enclave_network:         <<term_enclave_network,Enclave Network>>
:at_transit_network:         <<term_transit_network,Transit Network>>

:st_volume_mount:            <<term_volume_mount,Volume Mount>>
:st_volume_mount_s:          <<term_volume_mount,Volume Mounts>>
:st_port_map:                <<term_port_map,Port Map>>

// Configuration Regime Type mappings
:crg_atom_string:            <<crg_atom_string,String>>
:crg_atom_xname:             <<crg_atom_xname,XName>>
:crg_atom_fqin:              <<crg_atom_fqin,FQIN>>
:crg_atom_decimal:           <<crg_atom_decimal,Decimal>>
:crg_atom_ipv4:              <<crg_atom_ipv4,IPv4>>
:crg_atom_cidr:              <<crg_atom_cidr,CIDR>>
:crg_atom_domain:            <<crg_atom_domain,Domain>>
:crg_atom_port:              <<crg_atom_port,Port>>
:crg_list_cidr:              <<crg_list_cidr,CIDRList>>
:crg_list_domain:            <<crg_list_domain,DomainList>>

// end::mapping-section[]

== Overview

This Configuration Regime defines requirements for
{at_bottle_service}
deployment, specifying how
{at_nameplate_s}
configure container deployment and network security settings.

== Feature Groups

=== Core Service Identity

[cols="1,1,3"]
|===
|Assignment Variable |Attribute |Details

.4+|**`RBRN_MONIKER`**
|Purpose|
Unique moniker for
{at_bottle_service}
instance
|Type|
{crg_atom_xname}:
2-12 characters
|Required|
Yes
|Constraints|
.4+|**`RBRN_DESCRIPTION`**
|Purpose|
Human-readable description of service purpose
|Type|
{crg_atom_string}:
0-120 characters
|Required|
No
|Constraints|

.4+|**`RBRN_RUNTIME`**
|Purpose|
Container runtime to use for service deployment
|Type|
{crg_atom_string}:
"docker" or "podman"
|Required|
Yes
|Constraints|
Must be either "docker" or "podman"
|===

=== Ark Reference Configuration

Ark references identify which vessel consecration to deploy.
At runtime, these resolve against `RBRR_GAR_REPOSITORY` to form complete image paths.

[cols="1,1,3"]
|===
|Assignment Variable |Attribute |Details

.4+|**`RBRN_SENTRY_VESSEL`**
|Purpose|
Vessel identifier for
{at_sentry_image}
|Type|
{crg_atom_fqin}:
1-128 characters
|Required|
Yes
|Constraints|

.4+|**`RBRN_SENTRY_CONSECRATION`**
|Purpose|
Consecration timestamp for
{at_sentry_image}
|Type|
{crg_atom_fqin}:
1-128 characters
|Required|
Yes
|Constraints|

.4+|**`RBRN_BOTTLE_VESSEL`**
|Purpose|
Vessel identifier for
{at_bottle_image}
|Type|
{crg_atom_fqin}:
1-128 characters
|Required|
Yes
|Constraints|

.4+|**`RBRN_BOTTLE_CONSECRATION`**
|Purpose|
Consecration timestamp for
{at_bottle_image}
|Type|
{crg_atom_fqin}:
1-128 characters
|Required|
Yes
|Constraints|
|===

=== Entry Service Configuration

[cols="1,1,3"]
|===
|Assignment Variable |Attribute |Details

.4+|**`RBRN_ENTRY_MODE`**
|Purpose|
Mode for user-initiated entry functionality
|Type|
{crg_atom_string}: "disabled" or "enabled"
|Required|
Yes
|Constraints|

.4+|**`RBRN_ENTRY_PORT_WORKSTATION`**
|Purpose|
External port exposed on
{at_transit_network}
for user entry
|Type|
{crg_atom_port}
|Required|
When ENTRY_MODE=enabled
|Constraints|
Must be less than RBRN_UPLINK_PORT_MIN

.4+|**`RBRN_ENTRY_PORT_ENCLAVE`**
|Purpose|
Port used between
{at_sentry_container}
and
{at_bottle_container}
for entry traffic
|Type|
{crg_atom_port}
|Required|
When ENTRY_MODE=enabled
|Constraints|
Must be less than RBRN_UPLINK_PORT_MIN
|===

=== {at_enclave_network} Configuration 

[cols="1,1,3"]
|===
|Assignment Variable |Attribute |Details

.4+|**`RBRN_ENCLAVE_BASE_IP`**
|Purpose|
Base IPv4 address that defines the enclave network range
|Type|
{crg_atom_ipv4}
|Required|
Yes
|Constraints|

.4+|**`RBRN_ENCLAVE_NETMASK`**
|Purpose|
Network mask width for the enclave network addressing
|Type|
{crg_atom_decimal}:
8-30
|Required|
Yes
|Constraints|

.4+|**`RBRN_ENCLAVE_SENTRY_IP`**
|Purpose|
IP address assigned to the
{at_sentry_container}
for traffic mediation
|Type|
{crg_atom_ipv4}
|Required|
Yes
|Constraints|

.4+|**`RBRN_ENCLAVE_BOTTLE_IP`**
|Purpose|
IP address assigned to the
{at_bottle_container}
|Type|
{crg_atom_ipv4}
|Required|
Yes
|Constraints|
|===

=== Uplink Configuration

[cols="1,1,3"]
|===
|Assignment Variable |Attribute |Details

.4+|**`RBRN_UPLINK_PORT_MIN`**
|Purpose|
Minimum port number for bottle-initiated outbound connections
|Type|
{crg_atom_port}
|Required|
Yes
|Constraints|
Must be greater than any Entry port

.4+|**`RBRN_UPLINK_DNS_MODE`**
|Purpose|
DNS resolution mode for bottle-initiated requests
|Type|
{crg_atom_string}: "disabled", "global", or "allowlist"
|Required|
Yes
|Constraints|

.4+|**`RBRN_UPLINK_ACCESS_MODE`**
|Purpose|
IP access mode for bottle-initiated connections
|Type|
{crg_atom_string}: "disabled", "global", or "allowlist"
|Required|
Yes
|Constraints|

.4+|**`RBRN_UPLINK_ALLOWED_CIDRS`**
|Purpose|
CIDR ranges for allowed bottle-initiated outbound traffic
|Type|
{crg_list_cidr}
|Required|
When UPLINK_ACCESS_MODE=allowlist
|Constraints|

.4+|**`RBRN_UPLINK_ALLOWED_DOMAINS`**
|Purpose|
Domain names allowed for bottle-initiated DNS resolution
|Type|
{crg_list_domain}
|Required|
When UPLINK_DNS_MODE=allowlist
|Constraints|
|===

=== {st_volume_mount} Configuration

[cols="1,1,3"]
|===
|Assignment Variable |Attribute |Details

.4+|**`RBRN_VOLUME_MOUNTS`**
|Purpose|
Podman volume mount arguments for
{at_bottle_container}
|Type|
{crg_atom_string}:
0-240 characters
|Required|
No
|Constraints|
|===

== Core Term Definitions

[[term_bottle_service]]
{at_bottle_service}::
A complete service instance consisting of one 
{at_bottle_container} 
and one 
{at_sentry_container}, 
working together to provide secure functionality.

[[term_bottle_container]]
{at_bottle_container}::
A container that runs the actual service functionality, connected only to the 
{at_enclave_network} 
and configured with specific 
{st_volume_mount_s}.

[[term_bottle_image]]
{at_bottle_image}::
A container image that contains the service functionality intended to run within a 
{at_bottle_container}.

[[term_sentry_container]]
{at_sentry_container}::
A privileged container that enforces network security policies for a 
{at_bottle_service}, 
controlling all network traffic and providing DNS services.

[[term_sentry_image]]
{at_sentry_image}::
A container image that contains the security enforcement functionality for a 
{at_sentry_container}.

[[term_nameplate]]
{at_nameplate}::
A configuration file that defines all aspects of a 
{at_bottle_service},
including its images, network settings, and security policies.

[[term_moniker]]
{at_moniker}::
A unique identifier that distinguishes each 
{at_bottle_service} 
instance usable on a given
{at_workstation}.

[[term_workstation]]
{at_workstation}::
The local computing environment where the 
{at_user} 
runs containerized services.

[[term_transit_network]]
{at_transit_network}::
The network interface that connects a 
{at_sentry_container} 
to the
{at_workstation_p}
network resources, handling both user-initiated entry traffic
(in lower port space)
and bottle-initiated uplink traffic
(in higher port space).

[[term_enclave_network]]
{at_enclave_network}::
An isolated network connecting a 
{at_bottle_container} 
to its 
{at_sentry_container}.

[[term_port_map]]
{st_port_map}::
A specification of how network ports should be exposed and mapped between 
{at_sentry_container} 
and 
{at_bottle_container}.

[[term_volume_mount]]
{st_volume_mount}::
A configuration that allows 
{at_bottle_container_s} 
to access specified portions of the host filesystem.


