= Getting Started with Recipe Bottle

{at_recipe_bottle}
constructs container images under controlled conditions on trusted
{gcp_service}
infrastructure.
Developers retrieve these
{at_bottle_image_s}
and work within identical environments.
The
{rbtgi_repository}
serves as the single source of truth for container artifacts.

This guide explains the setup sequence and ongoing operational patterns.
Most of what follows happens once; the final sections describe day-to-day work.

== Depots and Roles

A
{rbtgi_depot}
is the logical facility where container images are constructed and retained.
The
{rbtgi_repository}
within the {rbtgi_depot} stores all
{rbtgi_image_s}
available for retrieval.
Most organizations require exactly one {rbtgi_depot}.

{at_recipe_bottle}
provides bash command-line administration of {rbtgi_depot} lifecycle and operations across roles.

* *{rbtr_payor}*: Creates and funds {rbtgi_depot_s}; creates {rbtr_governor_s}. Billing flows through the {rbtr_payor_p} linked account. Manual OAuth setup enables all subsequent automation.
* *{rbtr_governor}*: Administers credentials within a {rbtgi_depot}. Creates {rbtr_director_s} and {rbtr_retriever_s} via service account authentication.
* *{rbtr_director}*: Submits builds, manages {rbtgi_image_s}.
* *{rbtr_retriever}*: Pulls {rbtgi_image_s} for local use.

The
{rbtr_payor}
stands apart--requires manual console work and OAuth authentication for both {rbtgi_depot} and {rbtr_governor} lifecycle operations.
The
{rbtr_governor}
and all downstream roles authenticate via
{rbtgi_rbra_file}
credentials, enabling automation without human interaction.

== Phase 1: Establish

{rbtgo_payor_establish}
is a guide for manual steps taken using the Google Cloud Console to create the
{rbtgi_payor_project},
link a billing account,
enable required APIs,
and configure an OAuth 2.0 client.

This phase produces a
{rbtgi_json_key_file}
containing OAuth client credentials.
This file must not be committed to version control.

== Phase 2: Setup

The administrator who completed establishment now executes automation from their
{at_workstation}.

{rbtgo_payor_install}
takes the
{rbtgi_json_key_file}
and completes the OAuth handshake.
A browser window opens for authorization.
Upon success, the
{rbro_refresh_token}
is stored in `~/.rbw/rbro.env` with `600` permissions.
This file enables the
{rbtr_payor}
to authenticate for all future operations without repeating the browser flow.

{rbtgo_depot_create}
provisions the container build infrastructure.
Most installations require exactly one
{rbtgi_depot}-
a cohesive unit comprising a dedicated
{gcp_project_id},
a
{rbtgi_build_bucket},
a
{rbtgi_repository},
and the
{rbtr_mason}
service account that executes builds within the cloud.

The
{rbtr_payor}
can manage multiple {rbtgi_depot_s}:
{rbtgo_depot_list}
displays all active {rbtgi_depot_s} and their status;
{rbtgo_depot_destroy}
permanently removes a {rbtgi_depot} and all its resources.

The
{rbtr_payor}
then executes
{rbtgo_governor_reset}
to create the
{rbtr_governor}
service account within the
{rbtgi_depot}.
This {rbtr_payor} operation produces an
{rbtgi_rbra_file},
stored at the path specified by
{rbrr_governor_rbra_file}.
The
{rbtr_governor}
can now operate independently of the
{rbtr_payor}.

== Credential Administration

The
{rbtr_governor}
manages the roster of credentialed users throughout the
{rbtgi_depot}
lifecycle.
While credential creation is typically infrequent, this administrative function remains active.

{rbtgo_director_create}
provisions a
{rbtr_director}
service account, producing an
{rbtgi_rbra_file}
at the path specified by
{rbrr_director_rbra_file}.
Directors submit builds and manage images.

{rbtgo_retriever_create}
provisions a
{rbtr_retriever}
service account, producing an
{rbtgi_rbra_file}
at the path specified by
{rbrr_retriever_rbra_file}.
Retrievers pull images for local use.

The
{rbtr_governor}
also maintains visibility into issued credentials through
{rbtgo_sa_list}
and can revoke access through
{rbtgo_sa_delete}.

== Credential Files

Each {rbtr_role} maintains its own credential file.
Understanding these files helps administrators plan secure handling.

The
{rbtr_payor}
credentials reside in `~/.rbw/rbro.env`, containing the
{rbro_client_secret}
and
{rbro_refresh_token}.
This file exists only on the administrator's
{at_workstation}.

The
{rbtr_governor},
{rbtr_director},
and
{rbtr_retriever}
each have an
{rbtgi_rbra_file}
at paths defined in the repository configuration.
Each file contains
{giam_service_account}
credentials scoped to one role within one
{rbtgi_depot}.

All credential files require `600` permissions, exclusion from version control, and secure distribution to authorized users.
A credential file cannot operate outside its designated role and {rbtgi_depot}.

== Day-to-Day Operations

Once setup and credential administration are complete, ongoing work proceeds through
{rbtr_director}
and
{rbtr_retriever}
roles.

=== Director Operations

The
{rbtr_director}
manages the build lifecycle.

{rbtgo_trigger_build}
submits a container build to
{gcb_service}.
The
{rbtr_mason}
executes the build within the cloud and publishes the resulting
{rbtgi_image}
to the
{rbtgi_repository}.

{rbtgo_image_delete}
removes an
{rbtgi_image}
from the
{rbtgi_repository}.

**MISSING**: {rbtgi_image} listing operation is not yet implemented.

=== Retriever Operations

The
{rbtr_retriever}
accesses built artifacts.

{rbtgo_image_retrieve}
pulls an
{rbtgi_image}
from the
{rbtgi_repository}
to the local
{at_workstation}.

== Recovery

If `~/.rbw/rbro.env` is lost, the administrator obtains a fresh
{rbtgi_json_key_file}
from Google Cloud Console and re-executes
{rbtgo_payor_install}.

If OAuth tokens expire,
{rbtgo_payor_refresh}
obtains fresh credentials.

If
{rbtr_governor}
credentials are compromised or need rotation, the
{rbtr_payor}
executes
{rbtgo_governor_reset}
to replace the existing
{rbtr_governor}
service account with a fresh one, generating new
{rbtgi_rbra_file}
credentials.

To revoke a user's access, the
{rbtr_governor}
executes
{rbtgo_sa_delete}
for the target service account, invalidating the corresponding
{rbtgi_rbra_file}.
