NOTE: This operation creates an
{rbtgi_depot}
- a cohesive unit of Recipe Bottle infrastructure including the depot project, build bucket, container repository, and Mason service account that share their productive lifecycle.

The
{rbtr_payor}
creates a new depot infrastructure from the
{rbtgi_payor_project}:

// ⟦axs_inputs⟧
. *Validate Input Parameters*:
.. {rbbc_require}
`«INPUT_DEPOT_NAME»` provided as first argument
.. Validate depot name: lowercase letters, numbers, hyphens only, max 20 chars
.. {rbbc_require}
`«INPUT_REGION»` provided as second argument
.. {rbbc_call}
link:https://cloud.google.com/artifact-registry/docs/reference/rest/v1/projects.locations/list[artifactregistry.locations.list] to retrieve valid regions
.. {rbbc_require}
`«INPUT_REGION»` exists in valid regions list
.. {rbbc_fatal}
if invalid: "Invalid region. Valid regions: [list]"

// ⟦axs_behavior⟧
. *Authenticate as
{rbtr_payor}*:
.. Execute
{rbtoe_payor_authenticate}

. *Generate Depot Project ID*:
.. {rbbc_store}
`«TIMESTAMP»` as current time in YYYYMMDDHHmm format
.. Generate project ID: `rbw-«INPUT_DEPOT_NAME»-«TIMESTAMP»`
.. {rbbc_store}
as `«DEPOT_PROJECT_ID»`
.. {rbbc_require}
total length ≤ 30 characters

. *Create Depot Project*:
.. {rbbc_submit}
link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/create[projects.create] with:
... projectId: `«DEPOT_PROJECT_ID»`
... displayName: `RB Depot: «INPUT_DEPOT_NAME»`
... parent: `{rbrp_parent_type}s/{rbrp_parent_id}` (if parent_type != `none`)
.. {rbbc_await}
returned operation
.. {rbbc_require}
project creation successful

. *Link Billing Account*:
.. {rbbc_call}
link:https://cloud.google.com/billing/docs/reference/rest/v1/projects/updateBillingInfo[cloudbilling.projects.updateBillingInfo] for `«DEPOT_PROJECT_ID»`
.. Set billingAccountName: `billingAccounts/{rbrp_billing_account_id}`
.. {rbbc_require}
HTTP 200 response confirming billing linkage

. *Get Depot Project Number*:
.. {rbbc_call}
link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/get[projects.get] for `«DEPOT_PROJECT_ID»`
.. {rbbc_store}
`«PROJECT_NUMBER»` from `.name` field (CRM v3 returns `projects/{number}`)
.. {rbbc_require}
valid numeric project number after extracting from name

. *Enable Depot Project APIs*:
.. For each service in [`artifactregistry`, `cloudbuild`, `containeranalysis`, `storage`, `iam`, `serviceusage`]:
... Execute
{rbtoe_api_enable}
with service name and `«DEPOT_PROJECT_ID»`
.. {rbbc_require}
all APIs enabled successfully

. *Verify IAM Propagation*:
.. NOTE: After API enablement, IAM permissions may not be immediately available due to eventual consistency.
.. {rbbc_poll}
link:https://cloud.google.com/artifact-registry/docs/reference/rest/v1/projects.locations.repositories/list[artifactregistry.repositories.list] for `«DEPOT_PROJECT_ID»` in `«INPUT_REGION»`
.. Poll at `RBGC_EVENTUAL_CONSISTENCY_SEC` intervals until HTTP 200 or `RBGC_MAX_CONSISTENCY_SEC` timeout
.. {rbbc_require}
HTTP 200 response confirming IAM propagation complete
.. {rbbc_fatal}
if timeout: "IAM propagation timeout - artifactregistry API not accessible"

. *Create Build Bucket*:
.. Construct bucket name: `rbw-«INPUT_DEPOT_NAME»-bucket`
.. {rbbc_call}
link:https://cloud.google.com/storage/docs/json_api/v1/buckets/insert[storage.buckets.insert] with:
... name: `rbw-«INPUT_DEPOT_NAME»-bucket`
... location: `«INPUT_REGION»`
... project: `«DEPOT_PROJECT_ID»`
... lifecycle rule: delete objects after 1 day
.. {rbbc_store}
`«BUILD_BUCKET»` as created bucket name

. *Create Container Repository*:
.. Construct repository name: `rbw-«INPUT_DEPOT_NAME»-repository`
.. {rbbc_submit}
link:https://cloud.google.com/artifact-registry/docs/reference/rest/v1/projects.locations.repositories/create[artifactregistry.repositories.create] with:
... repositoryId: `rbw-«INPUT_DEPOT_NAME»-repository`
... format: `DOCKER`
... location: `«INPUT_REGION»`
... parent: `projects/«DEPOT_PROJECT_ID»/locations/«INPUT_REGION»`
.. {rbbc_await}
returned operation
.. {rbbc_store}
`«GAR_REPOSITORY»` as created repository name

. *Create
{rbtr_mason}
Service Account*:
.. NOTE: The
{rbtr_mason}
replaces Cloud Build's implicit service account to provide deterministic permissions and predictable authorization within the depot infrastructure.
.. {rbbc_call}
link:https://cloud.google.com/iam/docs/reference/rest/v1/projects.serviceAccounts/create[iam.serviceAccounts.create] with:
... accountId: `mason-«INPUT_DEPOT_NAME»`
... displayName: `Mason for RB Depot: «INPUT_DEPOT_NAME»`
... project: `«DEPOT_PROJECT_ID»`
.. {rbbc_store}
`«MASON_SERVICE_ACCOUNT»` from response `.email` field

. *Configure
{rbtr_mason}
Permissions*:
.. {rbbc_call}
link:https://cloud.google.com/artifact-registry/docs/reference/rest/v1/projects.locations.repositories/setIamPolicy[repositories.setIamPolicy] for `«GAR_REPOSITORY»`
... Add `«MASON_SERVICE_ACCOUNT»` with `roles/artifactregistry.admin`
.. {rbbc_call}
link:https://cloud.google.com/storage/docs/json_api/v1/buckets/setIamPolicy[buckets.setIamPolicy] for `«BUILD_BUCKET»`
... Add `«MASON_SERVICE_ACCOUNT»` with `roles/storage.objectViewer`
.. {rbbc_call}
link:https://cloud.google.com/resource-manager/reference/rest/v3/projects/setIamPolicy[projects.setIamPolicy] for `«DEPOT_PROJECT_ID»`
... Add `«MASON_SERVICE_ACCOUNT»` with `roles/viewer`

. *Enable Cloud Build service agent to impersonate
{rbtr_mason}*:
.. {rbbc_call}
link:https://cloud.google.com/iam/docs/reference/rest/v1/projects.serviceAccounts/setIamPolicy[serviceAccounts.setIamPolicy] for `«MASON_SERVICE_ACCOUNT»`
.. Add member: `service-«PROJECT_NUMBER»@gcp-sa-cloudbuild.iam.gserviceaccount.com`
.. Grant role: `roles/iam.serviceAccountTokenCreator`
.. {rbbc_require}
IAM binding successful (enables Cloud Build to execute as Mason)

// ⟦axs_outputs⟧
. *Display Depot Configuration*:
.. {rbbc_show}
depot creation successful
.. {rbbc_show}
required RBRR configuration values:
... `RBRR_DEPOT_PROJECT_ID=«DEPOT_PROJECT_ID»`
... `RBRR_GCP_REGION=«INPUT_REGION»`
... `RBRR_GAR_REPOSITORY=«GAR_REPOSITORY»`
.. {rbbc_show}
Mason service account: `«MASON_SERVICE_ACCOUNT»`
.. {rbbc_show}
depot ready for
{rbtr_governor}
creation

. *Update Depot Tracking*:
.. Execute
{rbtoe_depot_list_update}
to refresh depot project tracking

// ⟦axs_completion⟧
Successful execution creates depot infrastructure with configured build bucket, container repository, and Mason service account ready for governor creation.
