= RBWMBX: Buildx Multi-Platform Authentication Memo
:doctype: article
:toc:
:toc-title: Table of Contents
:sectnums:

== Problem Statement

Multi-platform container builds using `docker buildx` with Google Cloud Build face authentication challenges when pushing to Google Artifact Registry (GAR). This memo documents research findings, root cause analysis, and potential solutions.

=== Context

The Recipe Bottle `trigger_build` operation (RBSTB) submits container builds to Google Cloud Build using the Mason service account. Initial attempts to build multi-platform images (linux/amd64, linux/arm64, linux/arm/v7) using `docker buildx` failed with authentication errors when pushing to Artifact Registry.

=== Observed Failure

Multi-platform builds completed successfully but push operations failed with:

----
ERROR: failed to push us-central1-docker.pkg.dev/PROJECT/REPO/IMAGE:TAG:
failed to authorize: failed to fetch oauth token: unexpected status from
GET request to https://us-central1-docker.pkg.dev/v2/token?scope=...: 403 Forbidden
----

== Root Cause Analysis

=== The Catch-22 Situation

Docker Buildx offers two driver options, each with critical limitations:

[cols="1,1,1",options="header"]
|===
|Driver
|Multi-Platform Support
|GAR Credentials Access

|`docker` (default)
|✗ Not supported
|✓ Has credentials from `docker login`

|`docker-container`
|✓ Supported
|✗ Runs in isolated container
|===

**Key Finding**: The `docker` (default) driver explicitly does not support multi-platform builds:

----
ERROR: Multi-platform build is not supported for the docker driver.
Switch to a different driver, or turn on the containerd image store, and try again.
----

=== Docker-Container Driver Isolation

The `docker-container` driver creates an isolated BuildKit container that does not inherit host Docker daemon credentials. Per Docker buildx maintainer tonistiigi (https://github.com/docker/buildx/issues/3050[Issue #3050]):

____
"You need to either run `docker login` inside the dind environment or...mount that config file inside the dind container via volume"
____

This isolation is the core challenge: credentials configured in step 3 (docker login) are not available to the buildx builder container in step 6 (build-and-push).

=== GCR vs Artifact Registry Authentication Differences

The official https://github.com/GoogleCloudPlatform/solutions-build-multi-architecture-images-tutorial/blob/master/terraform/cloud-build/build-docker-image-trigger.yaml[Google Cloud Platform multi-arch tutorial] successfully pushes to `gcr.io` without explicit authentication, but this doesn't extend to Artifact Registry.

**Critical Difference**:

- `gcloud auth configure-docker` configures `\*.gcr.io` by default
- For Artifact Registry, you must explicitly specify: `gcloud auth configure-docker REGION-docker.pkg.dev`

Source: https://cloud.google.com/artifact-registry/docs/transition/changes-docker[Changes for Docker | Artifact Registry]

== Research Findings

=== Authentication Methods Investigated

. **Docker config.json**: BuildKit reads credentials from `$DOCKER_CONFIG/config.json` (https://docs.docker.com/build/buildkit/configure/[Configure BuildKit])

. **buildkitd.toml registry configuration**: Supports certificate-based authentication and config.json references (https://docs.docker.com/build/buildkit/toml-configuration/[buildkitd.toml reference])

. **Driver options**: The docker-container driver supports `--driver-opt env.<key>=<value>` for environment variables (https://docs.docker.com/build/builders/drivers/docker-container/[Docker container driver])

. **OAuth tokens**: `gcloud auth print-access-token` generates short-lived (60-minute) tokens suitable for automation

=== Known Issues and Limitations

. **Credential propagation**: Multiple GitHub issues document challenges with docker-container driver authentication (https://github.com/docker/buildx/issues/1613[#1613], https://github.com/docker/buildx/issues/2749[#2749])

. **Config.json credential stores**: macOS/Windows use credential stores (`credsStore`) instead of inline credentials, complicating volume mounting approaches

. **BuildKit registry auth**: No OAuth token support documented in buildkitd.toml; primarily certificate-based (https://github.com/moby/buildkit/issues/565[moby/buildkit#565])

== Potential Solutions

Given that GCR test proved the problem is universal to docker-container driver isolation, the following solutions remain viable:

=== Option 1: Pass Credentials via DOCKER_CONFIG Environment Variable

**Approach**: Create `config.json` with OAuth token, pass location to BuildKit via environment variable

**Implementation sketch**:
----
# Step 3: Create config.json (replace current docker login)
TOKEN=$(gcloud auth print-access-token)
mkdir -p /workspace/.docker
echo "{\"auths\":{\"gcr.io\":{\"username\":\"oauth2accesstoken\",\"password\":\"${TOKEN}\"}}}" > /workspace/.docker/config.json

# Step 6: Pass config location to builder
docker buildx create --name rbia-builder \
  --driver docker-container \
  --driver-opt env.DOCKER_CONFIG=/workspace/.docker \
  --use
----

**Pros**:
- Standard Docker authentication mechanism
- Environment variable approach documented in buildx driver options
- Short-lived token (60 minutes sufficient for Cloud Build)

**Cons**:
- Uncertain if BuildKit container can access `/workspace` mount
- May require additional volume mounting flags
- Needs experimentation to validate

**Status**: Untested, most promising approach

=== Option 2: buildkitd.toml with Registry Configuration

**Approach**: Use buildkitd.toml to configure registry authentication, pass via `--buildkitd-config` flag

**Implementation sketch**:
----
# Create buildkitd.toml
cat > /workspace/buildkitd.toml <<EOF
[registry."gcr.io"]
  http = false
  insecure = false
EOF

# Create and configure builder
docker buildx create --name rbia-builder \
  --driver docker-container \
  --buildkitd-flags '--config /etc/buildkit/buildkitd.toml' \
  --use
----

**Pros**:
- Official BuildKit configuration mechanism
- Explicit registry control

**Cons**:
- Limited documentation for OAuth token authentication
- Still requires credential file in accessible location
- May not support token-based auth (primarily certificate examples)

**Status**: Untested, secondary option if Option 1 fails

=== Option 3: Use Kaniko Instead of Docker Buildx

**Approach**: Switch from docker buildx to Google's kaniko builder for multi-platform images

**Pros**:
- Kaniko designed for containerized builds without docker daemon
- Native GCP integration, handles authentication differently
- Official Google solution for Cloud Build multi-platform

**Cons**:
- Complete rewrite of build steps (rbgjb06-rbgjb09)
- Different Dockerfile syntax requirements
- Less familiar tooling

**Status**: Architectural pivot, pursue if auth solutions fail

=== Option 4: Single-Architecture Build (amd64 only)

**Approach**: Abandon multi-platform requirement, build only `linux/amd64` using default docker driver

**Pros**:
- Works immediately with existing authentication
- No complexity, stable solution
- Sufficient for most current deployments

**Cons**:
- No ARM support (excludes Raspberry Pi, ARM cloud instances, Apple Silicon native)
- Limits future flexibility
- Defeats original multi-platform goal

**Status**: Fallback if all other options prove infeasible

=== Option 5: Manual Multi-Architecture via Manifest Combining

**Approach**: Build each architecture separately using default driver, manually combine into manifest list

**Pros**:
- Uses working authentication (default driver)
- Achieves multi-platform result
- No BuildKit isolation issues

**Cons**:
- Complex build orchestration (3 separate builds)
- Manual manifest creation and push
- Slower (sequential builds instead of parallel)
- Significant implementation effort

**Status**: Complex workaround, consider only if simpler options fail

== Current Implementation State

=== What Works (Steps 1-4)

The Cloud Build configuration successfully executes the following steps:

**Step 1: Derive TAG_BASE** (rbgjb01-derive-tag-base.sh)
----
TAG_BASE="$(date -u +%Y%m%dT%H%M%SZ)"
echo "${TAG_BASE}" > .tag_base
----

**Step 2: Get Docker Access Token** (rbgjb02-get-docker-token.sh)
----
gcloud auth print-access-token > /workspace/.docker-token
----

**Step 3: Docker Login to GAR** (rbgjb03-docker-login-gar.sh)
----
cat /workspace/.docker-token | docker login -u oauth2accesstoken \
  --password-stdin "https://us-central1-docker.pkg.dev"
rm /workspace/.docker-token
----

This authentication pattern **works for the host docker daemon** but doesn't propagate to isolated buildx containers.

**Step 4: QEMU for Cross-Platform** (rbgjb04-qemu-binfmt.sh)
----
docker run --privileged --rm tonistiigi/binfmt --install arm64,arm
----

Successfully enables emulation for non-native architectures.

=== What's Broken (Step 6)

**Step 6: Build and Push** (rbgjb06-build-and-push.sh) - Current state:

----
# Removed builder creation - using default builder
# docker buildx create --name rbia-builder --driver docker-container --use

docker buildx build \
  --platform="${_RBGY_PLATFORMS}" \
  --tag "${IMAGE_URI}" \
  --push \
  ...
----

**Failure**: Default docker driver doesn't support multi-platform builds:
----
ERROR: Multi-platform build is not supported for the docker driver.
----

=== Stitcher Refactor Status

**Complete**: Build JSON is dynamically generated from bash step scripts (rbgjb01-rbgjb09) via `zrbf_stitch_build_json()` in `rbf_Foundry.sh`. Static `rbgjb_build.json` removed.

== GCR Test Results

=== Hypothesis

Google Cloud Platform's official multi-arch tutorial (https://github.com/GoogleCloudPlatform/solutions-build-multi-architecture-images-tutorial[reference]) successfully pushes to `gcr.io` without explicit authentication in the BuildKit container. Testing whether GCR auto-authenticates with docker-container driver would prove whether the problem is GAR-specific or universal to isolated builders.

=== Test Configuration

**Modified files** (commit `10d1e2a`):

- `rbgjb06-build-and-push.sh`: Changed `IMAGE_URI` from `${_RBGY_GAR_LOCATION}-docker.pkg.dev/...` to `gcr.io/${_RBGY_GAR_PROJECT}/...`
- `rbgjb09-build-and-push-metadata.sh`: Changed `META_URI` similarly
- Re-enabled docker-container driver creation (`docker buildx create --name rbia-builder --driver docker-container --use`)

**Build execution**: Cloud Build ID `ddfb01b9-72fb-49bb-a996-9955285a6e22`

=== Test Results

**Multi-platform compilation**: ✓ **SUCCESS**

All three target platforms compiled successfully:
----
#14 [linux/amd64 3/3] RUN adduser -D appuser - DONE 0.2s
#13 [linux/arm/v7 3/3] RUN adduser -D appuser - DONE 0.3s
#15 [linux/arm64 3/3] RUN adduser -D appuser - DONE 0.3s
----

**Image export and push**: ✗ **FAILURE**

Push to GCR failed with identical authentication error as GAR:
----
ERROR: failed to push gcr.io/rbwg-d-proto-251230080456/rbev-busybox:20251231T135640Z-img:
failed to authorize: failed to fetch oauth token: unexpected status from GET request
to https://gcr.io/v2/token?scope=repository%3Arbwg-d-proto-251230080456%2Frbev-busybox%3Apull%2Cpush&service=gcr.io:
403 Forbidden
----

=== Critical Findings

. **Buildx driver configuration is correct**: Multi-platform builds completed successfully, proving QEMU setup and docker-container driver work properly

. **Authentication problem is universal**: Both GCR and Artifact Registry fail with 403 Forbidden when docker-container driver attempts to push

. **GCP "auto-authentication" only works for host daemon**: Cloud Build's automatic GCR/GAR authentication applies to the host docker daemon, not to isolated BuildKit containers created by `docker buildx create --driver docker-container`

. **The catch-22 is fundamental**: Cannot use default docker driver (has credentials, no multi-platform) AND cannot use docker-container driver (has multi-platform, no credentials)

=== Test Environment

- **Keeper depot**: `rbwg-d-proto-251230080456`
- **Region**: `us-central1`
- **Test vessel**: `rbev-vessels/rbev-busybox`
- **Target platforms**: `linux/amd64,linux/arm64,linux/arm/v7`
- **GCR test commit**: `10d1e2a` "Test buildx with GCR: switch from Artifact Registry to gcr.io"
- **GAR attempts**: `f021d54` and earlier commits

=== Implications

The docker-container driver's isolation prevents it from inheriting ANY Google Cloud registry credentials configured on the host, regardless of whether the target is GCR or GAR. A solution must provide credentials **inside** the BuildKit container environment.

== Next Steps

Based on GCR test results proving the authentication problem is universal, the following paces guide resolution:

. **Try DOCKER_CONFIG environment variable approach**: Implement Option 1 (most promising). Create config.json with OAuth token, pass to BuildKit via `--driver-opt env.DOCKER_CONFIG`. Test with actual build.

. **Try buildkitd.toml approach (if needed)**: Implement Option 2 if DOCKER_CONFIG fails. Alternative configuration mechanism for registry authentication.

. **Evaluate architectural pivot (if needed)**: If both authentication approaches fail, decide between Kaniko (Option 3), single-arch (Option 4), or manual manifest combining (Option 5).

. **Implement chosen solution**: Execute selected approach, validate full build-and-push cycle works.

. **Update RBSTB specification**: Document final solution in canonical trigger_build spec, including authentication mechanism, driver configuration, and any constraints.

== References

=== Multi-Platform Builds

- https://dev.to/tidalcloud/automating-multi-arch-container-images-builds-we-used-google-cloud-build-but-github-actions-would-also-work-clb[Automating multi-arch container images builds (DEV Community)]
- https://github.com/GoogleCloudPlatform/solutions-build-multi-architecture-images-tutorial[Google Cloud Platform multi-arch images tutorial]
- https://cloud.google.com/dataflow/docs/guides/multi-architecture-container[Build multi-architecture container images for Dataflow]

=== Docker Buildx & BuildKit

- https://docs.docker.com/build/builders/drivers/docker-container/[Docker container driver documentation]
- https://docs.docker.com/build/buildkit/configure/[Configure BuildKit]
- https://docs.docker.com/build/buildkit/toml-configuration/[buildkitd.toml reference]
- https://github.com/docker/buildx/pull/433[PR #433: Credential passing for BuildKit]

=== Authentication Issues

- https://github.com/docker/buildx/issues/3050[Issue #3050: How to pass docker hub credentials to docker-container driver]
- https://github.com/docker/buildx/issues/1613[Issue #1613: docker build fails to authenticate with private repository]
- https://github.com/docker/buildx/issues/2749[Issue #2749: Authentication not working only in buildx]
- https://github.com/docker/buildx/issues/1528[Issue #1528: docker login is not useful to buildx]
- https://github.com/moby/buildkit/issues/565[moby/buildkit #565: Login to private registry using command line]

=== Google Cloud Authentication

- https://cloud.google.com/artifact-registry/docs/docker/authentication[Configure authentication to Artifact Registry for Docker]
- https://cloud.google.com/artifact-registry/docs/transition/changes-docker[Changes for Docker (GCR to Artifact Registry migration)]
- https://cloud.google.com/artifact-registry/docs/configure-cloud-build[Connect to Cloud Build]
- https://cloud.google.com/build/docs/cloud-build-service-account[Default Cloud Build service account]

== Document History

[cols="1,2,4",options="header"]
|===
|Date
|Author
|Changes

|2025-12-31
|Claude Sonnet 4.5 + bhyslop
|Initial research findings documented

|2025-12-31
|Claude Sonnet 4.5 + bhyslop
|Added GCR test results, revised solutions based on universal auth failure
|===
