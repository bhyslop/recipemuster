= Getting Started with Recipe Bottle

{at_recipe_bottle}
provides deterministic container builds through
{gcp_service}
infrastructure.
When two developers build the same source, they produce identical
{at_bottle_image_s}.
The
{rbtgi_repository}
becomes the single source of truth for container artifacts.

This guide explains the setup sequence and ongoing operational patterns.
Most of what follows happens once; the final sections describe day-to-day work.

== The Role Hierarchy

{at_recipe_bottle}
defines a hierarchy of roles, each with distinct responsibilities and credential types.

The
{rbtr_payor}
stands apart from the others.
This role requires manual OAuth configuration through the Google Cloud Console and produces credentials that live in `~/.rbw/rbro.env`.
The
{rbtr_payor}
is the only role that interacts with Google through OAuth browser flows.

All other roles--{rbtr_governor}, {rbtr_director}, and {rbtr_retriever}--authenticate through
{rbtgi_rbra_file}
credentials stored on the filesystem.
These files contain
{giam_service_account}
keys that enable automated operations without human interaction.

This separation is deliberate: the
{rbtr_payor}
does the manual OAuth work once, enabling all subsequent roles to function through automation-friendly service account credentials.

== Phase 1: Establish

{rbtgo_payor_establish}
is entirely manual.
The administrator uses the Google Cloud Console to create the
{rbtgi_payor_project},
link a billing account,
enable required APIs,
and configure an OAuth 2.0 client.

This phase produces a
{rbtgi_json_key_file}
containing OAuth client credentials.
This file must not be committed to version control.

== Phase 2: Setup

The administrator who completed establishment now executes automation from their
{at_workstation}.

{rbtgo_payor_install}
takes the
{rbtgi_json_key_file}
and completes the OAuth handshake.
A browser window opens for authorization.
Upon success, the
{rbro_refresh_token}
is stored in `~/.rbw/rbro.env` with `600` permissions.
This file enables the
{rbtr_payor}
to authenticate for all future operations without repeating the browser flow.

{rbtgo_depot_create}
provisions the container build infrastructure.
Most installations require exactly one
{rbtgi_depot}--a
cohesive unit comprising a dedicated
{gcp_project_id},
a
{rbtgi_build_bucket},
a
{rbtgi_repository},
and the
{rbtr_mason}
service account that executes builds within the cloud.

{rbtgo_governor_create}
creates the
{rbtr_governor}
service account within the
{rbtgi_depot}.
This produces the first
{rbtgi_rbra_file},
stored at the path specified by
{rbrr_governor_rbra_file}.
The
{rbtr_governor}
can now operate independently of the
{rbtr_payor}.

== Credential Administration

The
{rbtr_governor}
manages the roster of credentialed users throughout the
{rbtgi_depot}
lifecycle.
While credential creation is typically infrequent, this administrative function remains active.

{rbtgo_director_create}
provisions a
{rbtr_director}
service account, producing an
{rbtgi_rbra_file}
at the path specified by
{rbrr_director_rbra_file}.
Directors submit builds and manage images.

{rbtgo_retriever_create}
provisions a
{rbtr_retriever}
service account, producing an
{rbtgi_rbra_file}
at the path specified by
{rbrr_retriever_rbra_file}.
Retrievers pull images for local use.

The
{rbtr_governor}
also maintains visibility into issued credentials through
{rbtgo_sa_list}
and can revoke access through
{rbtgo_sa_delete}.

== Credential Files

Each role maintains its own credential file.
Understanding these files helps administrators plan secure handling.

The
{rbtr_payor}
credentials reside in `~/.rbw/rbro.env`, containing the
{rbro_client_secret}
and
{rbro_refresh_token}.
This file exists only on the administrator's
{at_workstation}.

The
{rbtr_governor},
{rbtr_director},
and
{rbtr_retriever}
each have an
{rbtgi_rbra_file}
at paths defined in the repository configuration.
Each file contains
{giam_service_account}
credentials scoped to one role within one
{rbtgi_depot}.

All credential files require `600` permissions, exclusion from version control, and secure distribution to authorized users.
A credential file cannot operate outside its designated role and depot.

== Day-to-Day Operations

Once setup and credential administration are complete, ongoing work proceeds through
{rbtr_director}
and
{rbtr_retriever}
roles.

=== Director Operations

The
{rbtr_director}
manages the build lifecycle.

{rbtgo_trigger_build}
submits a container build to
{gcb_service}.
The
{rbtr_mason}
executes the build within the cloud and publishes the resulting
{rbtgi_image}
to the
{rbtgi_repository}.

{rbtgo_image_delete}
removes an
{rbtgi_image}
from the
{rbtgi_repository}.

**MISSING**: Image listing operation is not yet implemented.

=== Retriever Operations

The
{rbtr_retriever}
accesses built artifacts.

{rbtgo_image_retrieve}
pulls an
{rbtgi_image}
from the
{rbtgi_repository}
to the local
{at_workstation}.

== Recovery

If `~/.rbw/rbro.env` is lost, the administrator obtains a fresh
{rbtgi_json_key_file}
from Google Cloud Console and re-executes
{rbtgo_payor_install}.

If OAuth tokens expire,
{rbtgo_payor_refresh}
obtains fresh credentials.

To revoke a user's access, the
{rbtr_governor}
executes
{rbtgo_sa_delete}
for the target service account, invalidating the corresponding
{rbtgi_rbra_file}.
